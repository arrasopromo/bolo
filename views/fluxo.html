<!DOCTYPE html>
<html lang="pt-BR" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fluxo de Caixa - BelleCake</title>
    <link rel="stylesheet" href="/css/styles.css">
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://npmcdn.com/flatpickr/dist/l10n/pt.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-cream: #FFFBF7;
            --text-brown: #32221D;
            --card-white: #FFFFFF;
            --border-light: #E5E5E5;
            --primary-yellow: #FFC107;
            --secondary-caramel: #CD7A3E;
            --navbar-bg: #32221D; /* Added for menu consistency */
        }

        body {
            background: var(--bg-cream) !important;
            color: var(--text-brown) !important;
            margin: 0;
            overflow-x: hidden;
            font-family: 'Inter', sans-serif;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        /* Date Range Input Customization */
        .date-range-container {
            position: relative;
        }
        
        /* Ensure Flatpickr's input inherits our styles and make it important to override defaults */
        .date-range-input,
        .flatpickr-input {
            width: 100% !important;
            padding: 0.8rem 0.8rem 0.8rem 2.8rem !important; /* Extra padding for icon */
            border-radius: 8px !important;
            border: 1px solid #E5E5E5 !important;
            font-family: 'Inter', sans-serif !important;
            background: #FFFFFF !important;
            cursor: pointer !important;
            font-size: 1rem !important;
            color: var(--text-brown) !important;
            box-shadow: none !important;
            height: 46px !important; /* Fixed height to match button */
            box-sizing: border-box !important;
            transition: all 0.2s ease !important;
        }

        .date-range-input:focus,
        .flatpickr-input:focus {
            border-color: var(--secondary-caramel) !important;
            outline: none !important;
            box-shadow: 0 0 0 3px rgba(205, 122, 62, 0.1) !important;
        }

        /* Calendar Icon Positioning */
        .date-range-icon {
            position: absolute;
            left: 14px;
            top: 50%;
            transform: translateY(-50%);
            width: 20px;
            height: 20px;
            color: #999;
            z-index: 10;
            pointer-events: none;
        }

        /* Improved Period Presets */
        .period-preset {
            padding: 0.6rem 1.2rem;
            border: 1px solid #E5E5E5;
            background: #FFFFFF;
            border-radius: 8px; /* Slightly less rounded for a cleaner look */
            cursor: pointer;
            font-weight: 600;
            color: #777;
            transition: all 0.2s ease;
            font-size: 0.85rem;
            font-family: 'Inter', sans-serif;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .period-preset:hover {
            background: #F9F9F9;
            color: var(--secondary-caramel);
            border-color: var(--secondary-caramel);
            transform: translateY(-1px);
        }
        .period-preset.active {
            background: var(--secondary-caramel);
            color: white;
            border-color: var(--secondary-caramel);
            box-shadow: 0 4px 12px rgba(205, 122, 62, 0.25);
        }

        /* Layout Structure */
        .app-container {
            display: flex;
            min-height: 100vh;
        }

        /* Sidebar (Desktop) */
        .sidebar {
            width: 260px;
            background: #73401F; /* Explicitly set to requested color */
            color: #FFFFFF;
            display: flex;
            flex-direction: column;
            padding: 2rem 1.5rem;
            position: fixed;
            height: 100vh;
            left: 0;
            top: 0;
            z-index: 1000;
            border-right: 1px solid rgba(255,255,255,0.1);
            box-shadow: 2px 0 12px rgba(0,0,0,0.2);
        }

        .sidebar-logo-container {
            margin-bottom: 3rem;
            text-align: center;
        }

        .sidebar-logo {
            max-width: 140px;
            height: auto;
            filter: brightness(0) invert(1); /* Make logo white if it's dark */
        }

        .nav-menu {
            list-style: none;
            padding: 0;
            display: flex;
            flex-direction: column;
            gap: 0.8rem;
        }

        .nav-item {
            padding: 0.9rem 1.2rem;
            border-radius: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 1rem;
            transition: all 0.2s ease;
            color: rgba(255,255,255,0.7);
            font-weight: 500;
        }

        .nav-item:hover {
            background: rgba(255, 255, 255, 0.1);
            color: #FFFFFF;
            transform: translateX(4px);
        }

        .nav-item.active {
            background: var(--secondary-caramel);
            color: white;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }

        .nav-item i { width: 22px; height: 22px; }

        /* Mobile Header */
        .mobile-header {
            display: none;
            background-color: #73401F !important;
            color: #FFFFFF;
            height: 80px; /* Fixed height matching index */
            padding: 0 1.5rem;
            justify-content: flex-end; /* Logo is absolute, so align other items to right */
            align-items: center;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            z-index: 9999;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            overflow: visible !important; /* Allow logo to hang */
        }

        .mobile-logo {
            position: absolute;
            height: 120px; /* Large logo */
            width: auto;
            top: -15px;
            left: 15px;
            filter: brightness(0) invert(1);
            z-index: 10000;
        }

        .mobile-menu-dropdown {
            display: none;
            position: absolute;
            top: 100%;
            left: 0;
            width: 100%;
            background-color: #73401F !important; /* Updated color */
            padding: 1rem;
            flex-direction: column;
            gap: 0.5rem;
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
            border-bottom: 1px solid rgba(0,0,0,0.08);
            z-index: 10000;
        }

        .mobile-menu-dropdown .nav-item {
            color: rgba(255,255,255,0.7);
        }

        .mobile-menu-dropdown .nav-item:hover,
        .mobile-menu-dropdown .nav-item.active {
            background: rgba(255, 255, 255, 0.1);
            color: #FFFFFF;
        }

        .mobile-menu-dropdown.open {
            display: flex;
        }

        /* Main Content */
        .main-content {
            flex: 1;
            margin-left: 260px; /* Width of sidebar */
            padding: 2.5rem;
            background: #FFFFFF; /* White background for content area to contrast with cream sidebar/body */
            border-top-left-radius: 30px;
            border-bottom-left-radius: 30px;
            min-height: 100vh;
            box-shadow: -5px 0 20px rgba(0,0,0,0.02);
            margin-top: 0;
        }

        /* Views */
        .view-section {
            display: none;
            animation: fadeIn 0.4s ease;
        }

        .view-section.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(15px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Dashboard Styles */
        .header-dash {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2.5rem;
            flex-wrap: wrap;
            gap: 1rem;
        }

        h1 { margin: 0; font-size: 1.8rem; color: var(--text-brown); }
        
        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2.5rem;
        }

        .kpi-card {
            background: white;
            padding: 1.5rem;
            border-radius: 16px;
            border: 1px solid rgba(0,0,0,0.06);
            box-shadow: 0 4px 20px rgba(0,0,0,0.03);
            transition: transform 0.2s;
        }
        
        .kpi-card:hover { transform: translateY(-3px); }
        
        .kpi-title { font-size: 0.85rem; color: #888; margin-bottom: 0.5rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; }
        .kpi-value { font-size: 2rem; font-weight: 700; color: var(--text-brown); }

        .chart-section {
            background: white;
            padding: 1.5rem;
            border-radius: 16px;
            border: 1px solid rgba(0,0,0,0.06);
            margin-bottom: 2rem;
            box-shadow: 0 4px 20px rgba(0,0,0,0.03);
            position: relative;
        }

        .chart-container-wrapper {
            position: relative; 
            height: 350px; 
            width: 100%;
        }

        /* Form Styles */
        .form-card {
            background: white;
            padding: 2.5rem;
            border-radius: 16px;
            border: 1px solid rgba(0,0,0,0.06);
            max-width: 600px;
            margin: 0 auto;
            box-shadow: 0 10px 30px rgba(0,0,0,0.04);
        }

        .form-group { margin-bottom: 1.2rem; }
        .form-group label { display: block; margin-bottom: 0.5rem; font-size: 0.95rem; font-weight: 600; color: var(--text-brown); }
        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 0.9rem;
            border: 1px solid #ddd;
            border-radius: 12px;
            background: #fff;
            font-size: 1rem;
            transition: all 0.2s;
            box-shadow: 0 2px 5px rgba(0,0,0,0.03);
        }
        
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none;
            border-color: var(--secondary-caramel);
            box-shadow: 0 4px 12px rgba(205, 122, 62, 0.15);
        }

        .btn-submit {
            width: 100%;
            padding: 1rem;
            background: var(--secondary-caramel); /* Theme color */
            color: white;
            border: none;
            border-radius: 10px;
            font-weight: 700;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.2s;
            margin-top: 1rem;
        }
        .btn-submit:hover { background: #b86b35; transform: translateY(-2px); box-shadow: 0 5px 15px rgba(205, 122, 62, 0.3); }
        .btn-submit:active { transform: scale(0.98); }

        /* Responsive Tables */
        .table-responsive {
            width: 100%;
            overflow-x: auto;
            border-radius: 12px;
            border: 1px solid rgba(0,0,0,0.06);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 500px; /* Force scroll on small screens */
        }
        
        th { background: #F9F9F9; font-weight: 600; color: #666; font-size: 0.9rem; text-transform: uppercase; }
        td { color: var(--text-brown); }

        /* Responsive */
        .charts-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        @media (max-width: 900px) {
            .sidebar { display: none; }
            .mobile-header { display: flex; }
            .main-content {
                margin-left: 0;
                padding: 1.5rem;
                padding-top: 75px; /* Space for header */
                border-radius: 0;
                background: var(--bg-cream); /* Revert to cream on mobile for seamless feel */
            }
        }

        @media (max-width: 600px) {
            .charts-row { grid-template-columns: 1fr; }
            .chart-container-wrapper { height: 300px; }
            .kpi-grid { 
                grid-template-columns: repeat(2, 1fr); /* Force 2 columns on mobile */
                gap: 1rem;
            }
            .kpi-card { padding: 1rem; }
            .kpi-value { font-size: 1.5rem; }
        }

        @media (max-width: 380px) {
            .kpi-grid { grid-template-columns: 1fr; } /* Back to 1 column on very small screens */
        }


        @media (max-width: 480px) {
            .header-dash { flex-direction: column; align-items: flex-start; gap: 1rem; }
            .header-dash select { width: 100%; }
            .form-card { padding: 1.5rem; }
        }

        /* Filters Responsiveness */
        .filters-wrapper {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            width: 100%;
            margin-top: 1.5rem;
            align-items: flex-end;
            background: white;
            padding: 1.5rem;
            border-radius: 12px;
            border: 1px solid #eee;
            box-shadow: 0 2px 10px rgba(0,0,0,0.02);
        }

        .filter-item {
            flex: 1;
            min-width: 200px;
        }

        .filter-date {
            flex: 2;
            min-width: 300px;
        }

        .filter-btn-container {
            flex: 0 0 auto;
        }

        @media (max-width: 768px) {
            .filters-wrapper {
                flex-direction: column;
                align-items: stretch;
                padding: 1rem;
            }
            .filter-item, .filter-date, .filter-btn-container {
                width: 100%;
                min-width: 0;
                flex: none;
            }
            .filter-btn-container button {
                width: 100%;
                justify-content: center;
            }
            
            /* Adjust Period Presets for Mobile */
            .period-preset {
                flex: 1;
                text-align: center;
                padding: 0.8rem 0.5rem;
                font-size: 0.8rem;
            }
        }

        /* Mobile Sales Table as Cards */
        @media (max-width: 768px) {
            /* KPI Grid & Chart Section Mobile Optimizations */
            .kpi-grid {
                grid-template-columns: 1fr;
                gap: 1rem;
                margin-bottom: 1.5rem;
            }
            .kpi-card {
                padding: 1.2rem;
            }
            .chart-section {
                padding: 1rem;
                overflow-x: hidden; /* Prevent horizontal scroll */
            }

            table { min-width: 0 !important; } /* Override default min-width */
            #salesTable thead { display: none; }
            
            #salesTable tbody tr {
                display: block;
                background: white;
                margin-bottom: 1rem;
                border-radius: 12px;
                box-shadow: 0 2px 8px rgba(0,0,0,0.05);
                border: 1px solid #eee;
            }
            
            #salesTable tbody td {
                display: flex;
                justify-content: space-between;
                align-items: center;
                padding: 0.8rem 1rem;
                border-bottom: 1px solid #f5f5f5;
                text-align: right;
            }

            #salesTable tbody td .cell-content {
                text-align: right;
                font-weight: 500;
            }
            
            #salesTable tbody td:last-child { border-bottom: none; }
            
            #salesTable tbody td::before {
                content: attr(data-label);
                font-weight: 600;
                color: #888;
                text-align: left;
                font-size: 0.85rem;
                text-transform: uppercase;
            }
        }

        /* Fix Mobile Menu Background & Visibility */
        .mobile-menu-dropdown {
            background-color: #73401F !important;
            z-index: 2000;
            border-bottom-left-radius: 16px;
            border-bottom-right-radius: 16px;
        }

        .modal-overlay.open {
            display: flex !important;
        }

        @media (min-width: 1024px) {
            #breakEvenGoalCard {
                max-width: 600px;
                margin: 0 auto 1.5rem auto;
            }
        }

        /* Costs Chart Modal Responsive Styles */
        @media (max-width: 768px) {
            .costs-modal-content {
                padding: 1rem !important;
                width: 95% !important;
                max-height: 85vh; /* Increased height */
                overflow-y: auto;
            }
            .costs-modal-content h2 {
                font-size: 1.2rem !important;
                margin-bottom: 0.5rem !important;
            }
            .costs-chart-container {
                height: 200px !important; 
            }
            
            /* Mobile Fix for "Teve Taxa" */
            #feeInputContainer > div {
                flex-direction: column;
                align-items: flex-start !important;
                gap: 5px !important;
            }
            #feeInputContainer label {
                width: 100%;
                margin-bottom: 5px;
            }
        }
    </style>
</head>
<body>

    <!-- Mobile Header -->
    <header class="mobile-header">
        <a href="/fluxo">
            <img src="/images/LOGO%20BELLE%20CAKE.png" alt="Belle Cake" class="mobile-logo">
        </a>
        <div style="display: flex; align-items: center; gap: 10px; margin-left: auto;">
            <button onclick="openSaleModal()" style="background: #4CAF50; color: white; border: none; padding: 0.5rem 0.8rem; border-radius: 8px; font-weight: 700; font-size: 0.85rem; cursor: pointer; display: flex; align-items: center; gap: 5px;">
                <i data-lucide="plus-circle" style="width: 16px; height: 16px;"></i> Nova Venda
            </button>
            <button id="mobileMenuBtn" style="background:none; border:none; color:#FFFFFF; cursor: pointer;">
                <i data-lucide="menu" size="28"></i>
            </button>
        </div>
        <div class="mobile-menu-dropdown" id="mobileMenuDropdown">
            <div class="nav-item active" onclick="switchView('resumo')">
                <i data-lucide="layout-dashboard"></i> Resumo
            </div>
            <div class="nav-item" onclick="switchView('produtos')">
                <i data-lucide="package"></i> Cadastro Produto
            </div>
            <div class="nav-item" onclick="switchView('custos')">
                <i data-lucide="dollar-sign"></i> Custos Fixos
            </div>
            <div class="nav-item" onclick="switchView('vendas')">
                <i data-lucide="shopping-cart"></i> Vendas
            </div>
            <div class="nav-item" onclick="window.location.href='/membros'">
                <i data-lucide="arrow-left"></i> Voltar Painel
            </div>
        </div>
    </header>

    <div class="app-container">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-logo-container">
                <a href="/fluxo">
                    <img src="/images/LOGO%20BELLE%20CAKE.png" alt="Belle Cake Logo" class="sidebar-logo">
                </a>
            </div>
            
            <div style="padding: 0 1.5rem; margin-bottom: 1rem;">
                <button onclick="openSaleModal()" style="width: 100%; background: #4CAF50; color: white; border: none; padding: 0.8rem; border-radius: 8px; font-weight: 700; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; box-shadow: 0 4px 10px rgba(76, 175, 80, 0.3); transition: all 0.2s;">
                    <i data-lucide="plus-circle" style="width: 20px;"></i> NOVA VENDA
                </button>
            </div>

            <ul class="nav-menu">
                <li class="nav-item active" onclick="switchView('resumo')">
                    <i data-lucide="layout-dashboard"></i> Resumo
                </li>
                <li class="nav-item" onclick="switchView('produtos')">
                    <i data-lucide="package"></i> Cadastro Produto
                </li>
                <li class="nav-item" onclick="switchView('custos')">
                    <i data-lucide="dollar-sign"></i> Custos Fixos
                </li>
                <li class="nav-item" onclick="switchView('vendas')">
                    <i data-lucide="shopping-cart"></i> Vendas
                </li>
            </ul>
            <div style="margin-top: auto;">
                <div class="nav-item" onclick="window.location.href='/membros'" style="color: #FFFFFF;">
                    <i data-lucide="arrow-left"></i> Voltar Painel
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            
            <!-- Top User Bar -->
            <div style="display: flex; justify-content: flex-end; align-items: center; margin-top: 2rem; margin-bottom: 2rem;">
                <div style="position: relative;">
                    <div onclick="toggleUserMenu()" style="display: flex; align-items: center; gap: 10px; background: white; padding: 0.5rem 1rem; border-radius: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); border: 1px solid #eee; cursor: pointer;">
                        <div style="width: 32px; height: 32px; background: #FFFBF7; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: var(--secondary-caramel);">
                            <i data-lucide="user" style="width: 18px; height: 18px;"></i>
                        </div>
                        <span id="topUserName" style="font-weight: 600; font-size: 0.95rem; color: var(--text-brown);">Ol√°</span>
                        <i data-lucide="chevron-down" style="width: 16px; height: 16px; color: #999;"></i>
                    </div>
                    
                    <!-- Dropdown Menu -->
                    <div id="userMenuDropdown" style="display: none; position: absolute; right: 0; top: 120%; background: white; border: 1px solid #eee; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); min-width: 180px; padding: 0.5rem; z-index: 1000; flex-direction: column;">
                         <div onclick="toggleMetaCard(true)" style="padding: 0.8rem; border-radius: 8px; cursor: pointer; display: flex; align-items: center; gap: 8px; font-size: 0.9rem; color: var(--text-brown); transition: background 0.2s;" onmouseover="this.style.background='#f5f5f5'" onmouseout="this.style.background='white'">
                             <i data-lucide="eye"></i> Mostrar Meta
                         </div>
                    </div>
                </div>
            </div>

            <!-- VIEW: RESUMO -->
            <section id="view-resumo" class="view-section active">
                <div class="header-dash" style="flex-direction: column; align-items: flex-start; margin-bottom: 2rem;">
                    <h1 style="margin-bottom: 1rem;">Resumo Financeiro</h1>

                    <!-- Meta / Break-Even Section Removed (Duplicate) -->
                    
                    <div class="filters-wrapper">
                        
                        <!-- Filter by Product -->
                        <div class="filter-item">
                            <label for="productSearchInput" style="display: block; margin-bottom: 0.5rem; font-weight: 600; font-size: 0.9rem; color: #555;">Filtrar por produto</label>
                            
                            <div style="position: relative;" id="productFilterContainer">
                                <i data-lucide="package" style="position: absolute; left: 12px; top: 50%; transform: translateY(-50%); width: 18px; color: #999;"></i>
                                <input type="text" id="productSearchInput" placeholder="Todos produtos" 
                                       autocomplete="off"
                                       onfocus="openProductDropdown()" 
                                       oninput="filterProductDropdown(this.value)"
                                       style="width: 100%; padding: 0.8rem 2.5rem 0.8rem 2.5rem; border-radius: 8px; border: 1px solid #ddd; background: white; font-family: 'Inter', sans-serif; cursor: pointer;">
                                <input type="hidden" id="filterProduct" value="all">
                                
                                <div id="productDropdownList" style="display: none; position: absolute; top: 100%; left: 0; width: 100%; background: white; border: 1px solid #ddd; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); z-index: 100; max-height: 250px; overflow-y: auto; margin-top: 5px;">
                                    <!-- Populated by JS -->
                                </div>
                                
                                <i data-lucide="chevron-down" style="position: absolute; right: 12px; top: 50%; transform: translateY(-50%); width: 18px; color: #999; pointer-events: none;"></i>
                            </div>
                        </div>

                        <!-- Filter by Date (Range) -->
                        <div class="filter-date">
                             <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; font-size: 0.9rem; color: #555;">Filtrar por data</label>
                             <div class="date-range-container">
                                <i data-lucide="calendar" class="date-range-icon"></i>
                                <input type="text" id="filterDateRange" class="date-range-input" placeholder="Selecione o per√≠odo...">
                             </div>
                        </div>

                        <!-- Filter Button -->
                        <div class="filter-btn-container">
                            <button id="btnApplyFilters" style="padding: 0.8rem 1.5rem; background: var(--secondary-caramel); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; display: flex; align-items: center; gap: 0.5rem; transition: all 0.2s; height: 46px;">
                                <i data-lucide="filter" style="width: 18px;"></i>
                                Filtrar
                            </button>
                        </div>

                    </div>

                    <div id="dashboardLoading" style="display:none; text-align:center; padding: 2rem; width: 100%;">
                         <div style="display: inline-block; animation: spin 1s linear infinite;">
                             <i data-lucide="loader-2" style="width: 24px; height: 24px; color: var(--secondary-caramel);"></i>
                         </div>
                         <p style="color: #888; margin-top: 0.5rem;">Atualizando dados...</p>
                    </div>
                    
                    <!-- Quick Presets -->
                    <div style="display: flex; gap: 0.5rem; margin-top: 1rem; flex-wrap: wrap;">
                        <button class="period-preset" data-period="today">Hoje</button>
                        <button class="period-preset" data-period="yesterday">Ontem</button>
                        <button class="period-preset" data-period="7days">7 Dias</button>
                        <button class="period-preset active" data-period="thismonth">Este M√™s</button>
                        <button class="period-preset" data-period="30days">√öltimos 30 dias</button>
                    </div>
                </div>

                <!-- Break-even Goal Card (Hidden by default until data is loaded) -->
                <div id="breakEvenGoalCard" style="display: block; background: white; border-radius: 12px; padding: 1.5rem; margin-bottom: 1.5rem; border: 1px solid var(--border-light); box-shadow: 0 2px 8px rgba(0,0,0,0.03);">
                    <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 1rem;">
                        <div>
                            <h3 style="margin: 0; font-size: 1.1rem; color: var(--text-brown);">Meta de Ponto de Equil√≠brio</h3>
                            <p style="margin: 0.5rem 0 0 0; color: #666; font-size: 0.9rem;">Quanto falta para cobrir todos os custos do m√™s.</p>
                        </div>
                        <div style="background: #E8F5E9; color: #2E7D32; padding: 0.4rem 0.8rem; border-radius: 20px; font-size: 0.85rem; font-weight: 600;">
                            Meta: <span id="beGoalValue">R$ 0,00</span>
                        </div>
                    </div>
                    
                    <div style="background: #F5F5F5; height: 12px; border-radius: 6px; overflow: hidden; margin-bottom: 0.8rem;">
                        <div id="beProgressBar" style="width: 0%; height: 100%; background: linear-gradient(90deg, #FFC107, #CD7A3E); border-radius: 6px; transition: width 1s ease;"></div>
                    </div>
                    
                    <div style="display: flex; justify-content: space-between; font-size: 0.9rem; font-weight: 500;">
                        <span>Vendido: <span id="beCurrentValue" style="color: var(--secondary-caramel);">R$ 0,00</span></span>
                        <span id="bePercentage">0%</span>
                    </div>
                </div>

                <div class="kpi-grid">
                    <div class="kpi-card">
                        <div class="kpi-title">Vendas (Per√≠odo)</div>
                        <div class="kpi-value" id="totalSales">R$ 0,00</div>
                    </div>
                    <div class="kpi-card">
                        <div class="kpi-title">Custo Vari√°vel</div>
                        <div class="kpi-value" id="totalVariableCost" style="color: #F44336;">R$ 0,00</div>
                    </div>
                    <div class="kpi-card">
                        <div class="kpi-title">Custo Fixo (M√™s)</div>
                        <div class="kpi-value" id="totalFixedCostDash" style="color: #F44336;">R$ 0,00</div>
                    </div>
                    <div class="kpi-card">
                        <div class="kpi-title">Lucro L√≠quido</div>
                        <div class="kpi-value" id="totalProfit" style="color: #4CAF50;">R$ 0,00</div>
                    </div>
                    <div class="kpi-card">
                        <div class="kpi-title">Ticket M√©dio</div>
                        <div class="kpi-value" id="ticketAvg">R$ 0,00</div>
                    </div>
                    <div class="kpi-card">
                        <div class="kpi-title">Produtos Vendidos</div>
                        <div class="kpi-value" id="totalItems">0</div>
                    </div>
                </div>

                <div class="charts-row">
                    <div class="chart-section" style="margin-bottom: 0;">
                        <h3 style="margin-top:0; margin-bottom: 1.5rem; font-size: 1.2rem;">Desempenho de Vendas</h3>
                        <div class="chart-container-wrapper">
                            <canvas id="salesChart"></canvas>
                        </div>
                    </div>

                    <div class="chart-section" style="margin-bottom: 0;">
                        <h3 style="margin-top:0; margin-bottom: 1.5rem; font-size: 1.2rem;">Ticket M√©dio Di√°rio</h3>
                        <div class="chart-container-wrapper">
                            <canvas id="ticketChart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Top Products Section -->
                <div class="chart-section">
                    <h3 style="margin-top:0; margin-bottom: 1.5rem; font-size: 1.2rem;">Produtos Mais Vendidos</h3>
                    <div class="table-responsive">
                        <table style="width: 100%; border-collapse: collapse;">
                            <thead style="background: #f9f9f9; border-bottom: 2px solid #eee;">
                                <tr>
                                    <th style="padding: 1rem; text-align: left;">Produto</th>
                                    <th style="padding: 1rem; text-align: left;">Qtd</th>
                                    <th style="padding: 1rem; text-align: left;">Faturamento</th>
                                </tr>
                            </thead>
                            <tbody id="topProductsTable">
                                <!-- Populated by JS -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- VIEW: CUSTOS -->
            <section id="view-custos" class="view-section">
                <div class="header-dash" style="flex-direction: column; align-items: flex-start; gap: 10px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; width: 100%;">
                        <h1>Custos Fixos</h1>
                        <button onclick="openCostsChartModal()" style="background: var(--card-white); border: 1px solid var(--border-light); color: var(--text-brown); padding: 0.5rem 1rem; border-radius: 8px; cursor: pointer; font-weight: 600; display: flex; align-items: center; gap: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05);">
                            <i data-lucide="pie-chart" style="width: 18px; height: 18px; color: var(--secondary-caramel);"></i> Ver gr√°fico
                        </button>
                    </div>
                    <div style="background: #FFF0F0; padding: 0.5rem 1rem; border-radius: 8px; border: 1px solid #FFCDD2; color: #D32F2F; font-weight: 700; align-self: flex-start;">
                        Total: <span id="viewCustosTotal">R$ 0,00</span>
                    </div>
                </div>

                <!-- AI Classification Tool (Style matched to Equilibrio) -->
                <div class="classification-container calculator-card" style="margin: 0 auto 2rem auto; max-width: 600px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); border: 1px solid var(--border-light); padding: 1.5rem; border-radius: 16px; background: white;">
                    <h3 class="calc-title" style="font-size: 1.3rem; margin-bottom: 1rem; color: var(--text-brown); font-weight: 700;">
                        <i data-lucide="search" style="vertical-align: middle; margin-right: 5px; color: var(--primary-yellow);"></i> 
                        Consultar se √© custo vari√°vel ou fixo
                    </h3>
                    <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                        <input type="text" id="costInput" placeholder="Ex: Farinha, Aluguel, Embalagem..." style="flex: 1; min-width: 200px; padding: 0.8rem; border: 1px solid var(--border-light); border-radius: 8px; background: #FAFAFA; color: var(--text-brown); font-family: inherit; font-size: 0.95rem;">
                <button id="btnConsultar" class="btn-submit" style="margin: 0; padding: 0.8rem 1.5rem; border-radius: 8px; width: auto; background: var(--primary-yellow); color: var(--seal-brown); font-weight: 600;">
                            Consultar
                        </button>
                    </div>
                    <div id="consultLoading" style="display: none; margin-top: 1rem; color: var(--text-muted); text-align: center;">
                        <i data-lucide="loader-2" class="spin"></i> Verificando...
                    </div>
                    <div id="consultResult" style="margin-top: 1rem; display: none; padding: 1rem; border-radius: 8px; text-align: left;">
                        <strong id="resClass" style="font-size: 1.1rem; display: block; margin-bottom: 0.3rem;"></strong>
                        <span id="resDesc" style="font-size: 0.9rem;"></span>
                    </div>
                </div>
                
                <div class="form-card">
                    <h3 style="margin-top:0; margin-bottom: 1.5rem;">Novo Custo Fixo</h3>
                    <form id="fixedCostForm">
                        <input type="hidden" id="editCostId">
                        <div class="form-group">
                            <label>Descri√ß√£o do Custo</label>
                            <input type="text" id="costName" placeholder="Ex: Aluguel, Internet, Luz" required>
                        </div>
                        <div class="form-group">
                            <label>Valor (R$)</label>
                            <input type="number" id="costAmount" step="0.01" placeholder="0.00" required>
                        </div>
                        
                        <div class="form-group">
                            <label style="margin-bottom: 0.8rem; display: block;">Tipo de Recorr√™ncia</label>
                            <div class="recurrence-options">
                                <label class="radio-card">
                                    <input type="radio" name="recurrenceType" value="monthly" checked onchange="toggleInstallments()"> 
                                    <span class="radio-label">
                                        <i data-lucide="calendar-check-2"></i> Mensal
                                    </span>
                                </label>
                                <label class="radio-card">
                                    <input type="radio" name="recurrenceType" value="installment" onchange="toggleInstallments()"> 
                                    <span class="radio-label">
                                        <i data-lucide="credit-card"></i> Parcelado
                                    </span>
                                </label>
                            </div>
                        </div>

                        <style>
                            .recurrence-options {
                                display: flex;
                                gap: 1rem;
                            }
                            .radio-card input {
                                display: none;
                            }
                            .radio-label {
                                display: flex;
                                align-items: center;
                                gap: 0.5rem;
                                padding: 0.8rem 1.2rem;
                                border: 1px solid var(--input-border);
                                border-radius: 8px;
                                cursor: pointer;
                                background: var(--input-bg);
                                color: var(--text-muted);
                                transition: all 0.2s;
                                font-weight: 500;
                            }
                            .radio-card input:checked + .radio-label {
                                background: var(--primary-yellow);
                                color: white;
                                border-color: var(--primary-yellow);
                                box-shadow: 0 4px 10px rgba(205, 122, 62, 0.2);
                            }
                            .radio-label:hover {
                                border-color: var(--primary-yellow);
                            }
                        </style>

                        <div class="form-group" id="installmentsGroup" style="display: none;">
                            <label>N√∫mero de Parcelas</label>
                            <input type="number" id="costInstallments" min="2" value="2" placeholder="Ex: 10">
                        </div>

                        <div class="form-group" id="purchaseDateGroup" style="display: none;">
                            <label>Data da Compra</label>
                            <div style="font-size: 0.8rem; color: #666; margin-bottom: 0.3rem;">√ötil para registrar compras passadas.</div>
                            <input type="date" id="costPurchaseDate">
                        </div>

                        <button type="submit" class="btn-submit">Registrar Custo</button>
                    </form>
                </div>

                <div style="margin-top: 3rem;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; flex-wrap: wrap; gap: 10px;">
                        <h3 style="margin: 0;">Custos deste M√™s</h3>
                        <div id="bulkActions" style="display: none; gap: 10px;">
                            <button onclick="deleteSelectedCosts()" style="background: #FFCDD2; color: #D32F2F; border: 1px solid #EF9A9A; padding: 0.5rem 1rem; border-radius: 8px; font-weight: 600; cursor: pointer;">
                                <i data-lucide="trash-2" style="width: 16px; height: 16px; vertical-align: middle;"></i> Remover Selecionados
                            </button>
                        </div>
                    </div>
                    <div style="margin-bottom: 1rem;">
                        <label style="display: inline-flex; align-items: center; cursor: pointer; font-size: 0.9rem; color: #666;">
                            <input type="checkbox" id="selectAllCosts" onchange="toggleSelectAllCosts()" style="margin-right: 8px;">
                            Selecionar Todos
                        </label>
                    </div>
                    <div id="fixedCostsList" style="display: grid; gap: 1rem; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));">
                        <!-- Populated by JS -->
                    </div>
                </div>
            </section>

            <!-- VIEW: PRODUTOS -->
            <section id="view-produtos" class="view-section">
                <div class="header-dash">
                    <h1>Cadastro de Produtos</h1>
                </div>
                
                <div class="form-card">
                    <h3 style="margin-top:0; margin-bottom: 1.5rem;">Novo Produto</h3>
                    <form id="productForm">
                        <input type="hidden" id="editProductId">
                        <div class="form-group">
                            <div style="font-size: 0.85rem; color: #666; margin-bottom: 0.5rem; background: #FFFBF7; padding: 0.8rem; border-radius: 8px; border: 1px dashed #CD7A3E;">
                                üí° <strong>Dica:</strong> Cadastre o nome completo (Sabor + Tamanho) caso o pre√ßo varie.<br>
                                <span style="font-style: italic; display: block; margin-top: 0.3rem;">Ex: Bolo Chantilly Ninho e Nutella Aro 15</span>
                            </div>
                            <label>Nome do Produto</label>
                            <input type="text" id="prodName" placeholder="Ex: Bolo Chantilly Ninho e Nutella Aro 15" required>
                        </div>
                        <div class="form-group">
                            <label>Custo Vari√°vel (R$)</label>
                            <input type="number" id="prodCost" step="0.01" placeholder="0.00" required>
                        </div>
                        <div class="form-group">
                            <label>Pre√ßo de Venda (R$)</label>
                            <input type="number" id="prodPrice" step="0.01" placeholder="0.00" required>
                        </div>
                        <button type="submit" class="btn-submit">Cadastrar Produto</button>
                    </form>
                </div>
                
                <div style="margin-top: 3rem;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; flex-wrap: wrap; gap: 10px;">
                        <h3 style="margin: 0;">Produtos Cadastrados</h3>
                        <div id="productBulkActions" style="display: none; gap: 10px;">
                            <button onclick="deleteSelectedProducts()" style="background: #FFCDD2; color: #D32F2F; border: 1px solid #EF9A9A; padding: 0.5rem 1rem; border-radius: 8px; font-weight: 600; cursor: pointer;">
                                <i data-lucide="trash-2" style="width: 16px; height: 16px; vertical-align: middle;"></i> Remover Selecionados
                            </button>
                        </div>
                    </div>
                    <div style="margin-bottom: 1rem;">
                        <label style="display: inline-flex; align-items: center; cursor: pointer; font-size: 0.9rem; color: #666;">
                            <input type="checkbox" id="selectAllProducts" onchange="toggleSelectAllProducts()" style="margin-right: 8px;">
                            Selecionar Todos
                        </label>
                    </div>
                    <div id="productsList" style="display: grid; gap: 1rem; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));">
                        <!-- Populated by JS -->
                    </div>
                </div>
            </section>

            <!-- VIEW: VENDAS -->
            <section id="view-vendas" class="view-section">
                <div class="header-dash" style="flex-direction: column; align-items: flex-start; margin-bottom: 2rem;">
                    <h1 style="margin-bottom: 1rem;">Registro de Vendas</h1>
                    
                    <div class="filters-wrapper">
                        <!-- Filter by Product -->
                        <div class="filter-item">
                            <label for="productSearchInputSales" style="display: block; margin-bottom: 0.5rem; font-weight: 600; font-size: 0.9rem; color: #555;">Filtrar por produto</label>
                            
                            <div style="position: relative;" id="productFilterContainerSales">
                                <i data-lucide="package" style="position: absolute; left: 12px; top: 50%; transform: translateY(-50%); width: 18px; color: #999;"></i>
                                <input type="text" id="productSearchInputSales" placeholder="Todos produtos" 
                                       autocomplete="off"
                                       onfocus="openProductDropdownSales()" 
                                       oninput="filterProductDropdownSales(this.value)"
                                       style="width: 100%; padding: 0.8rem 2.5rem 0.8rem 2.5rem; border-radius: 8px; border: 1px solid #ddd; background: white; font-family: 'Inter', sans-serif; cursor: pointer;">
                                <input type="hidden" id="filterProductSales" value="all">
                                
                                <div id="productDropdownListSales" style="display: none; position: absolute; top: 100%; left: 0; width: 100%; background: white; border: 1px solid #ddd; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); z-index: 100; max-height: 250px; overflow-y: auto; margin-top: 5px;">
                                    <!-- Populated by JS -->
                                </div>
                                
                                <i data-lucide="chevron-down" style="position: absolute; right: 12px; top: 50%; transform: translateY(-50%); width: 18px; color: #999; pointer-events: none;"></i>
                            </div>
                        </div>

                        <!-- Filter by Date -->
                        <div class="filter-date">
                             <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; font-size: 0.9rem; color: #555;">Filtrar por data</label>
                             <div class="date-range-container">
                                <i data-lucide="calendar" class="date-range-icon"></i>
                                <input type="text" id="filterDateRangeSales" class="date-range-input" placeholder="Selecione o per√≠odo...">
                             </div>
                        </div>

                        <!-- Filter Button -->
                        <div class="filter-btn-container">
                            <button id="btnApplyFiltersSales" onclick="loadRecentSales()" style="padding: 0.8rem 1.5rem; background: var(--secondary-caramel); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; display: flex; align-items: center; gap: 0.5rem; transition: all 0.2s; height: 46px;">
                                <i data-lucide="filter" style="width: 18px;"></i>
                                Filtrar
                            </button>
                        </div>
                    </div>

                    <!-- Quick Presets -->
                    <div style="display: flex; gap: 0.5rem; margin-top: 1rem; flex-wrap: wrap;">
                         <button class="period-preset sales-preset active" type="button" data-period="today" onclick="setSalesPeriod('today')">Hoje</button>
                         <button class="period-preset sales-preset" type="button" data-period="yesterday" onclick="setSalesPeriod('yesterday')">Ontem</button>
                         <button class="period-preset sales-preset" type="button" data-period="7days" onclick="setSalesPeriod('7days')">7 Dias</button>
                         <button class="period-preset sales-preset" type="button" data-period="30days" onclick="setSalesPeriod('30days')">√öltimos 30 dias</button>
                         <button class="period-preset sales-preset" type="button" data-period="all" onclick="setSalesPeriod('all')">Todo o per√≠odo</button>
                    </div>
                </div>

                <div style="margin-top: 1rem;">
                    <div class="table-responsive" style="background: white; padding: 1rem; border-radius: 16px; border: 1px solid #eee; box-shadow: 0 4px 20px rgba(0,0,0,0.03);">
                        <table id="salesTable" style="width: 100%; border-collapse: collapse;">
                            <thead style="background: #FFFBF7; border-bottom: 2px solid #eee;">
                                <tr>
                                    <th style="padding: 1rem; text-align: left;">Data</th>
                                    <th style="padding: 1rem; text-align: left;">Produto</th>
                                    <th style="padding: 1rem; text-align: left;">Qtd</th>
                                    <th style="padding: 1rem; text-align: left;">M√©todo</th>
                                    <th style="padding: 1rem; text-align: left;">Valor Total</th>
                                    <th style="padding: 1rem; text-align: left;">Lucro</th>
                                    <th style="padding: 1rem; text-align: right;">A√ß√µes</th>
                                </tr>
                            </thead>
                            <tbody id="salesTableBody">
                                <!-- Populated by JS -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>

        </main>
    </div>

    <!-- New Sale Modal -->
    <div id="newSaleModal" class="modal-overlay">
        <div class="modal-content form-card">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                <h3 style="margin: 0;">Nova Venda</h3>
                <button onclick="closeSaleModal()" style="background: none; border: none; cursor: pointer; color: #666;">
                    <i data-lucide="x" style="width: 24px; height: 24px;"></i>
                </button>
            </div>

            <!-- Stepper -->
            <div class="stepper-container">
                <div class="step-indicator active" id="step1-indicator">1</div>
                <div class="step-line"></div>
                <div class="step-indicator" id="step2-indicator">2</div>
            </div>

            <!-- Voice Status (Global for modal) -->
            <div id="voiceStatus" style="margin-bottom: 1rem; font-size: 0.85rem; color: #666; font-style: italic; display: none; text-align: center;"></div>
            <style>
                .recording { animation: pulse 1.5s infinite; }
                @keyframes pulse {
                    0% { box-shadow: 0 0 0 0 rgba(244, 67, 54, 0.4); }
                    70% { box-shadow: 0 0 0 10px rgba(244, 67, 54, 0); }
                    100% { box-shadow: 0 0 0 0 rgba(244, 67, 54, 0); }
                }
                .stepper-container {
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    margin-bottom: 1.5rem;
                }
                .step-indicator {
                    width: 30px;
                    height: 30px;
                    border-radius: 50%;
                    background: #eee;
                    color: #999;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    font-weight: 700;
                    font-size: 0.9rem;
                    transition: all 0.3s;
                }
                .step-indicator.active {
                    background: var(--secondary-caramel);
                    color: white;
                }
                .step-line {
                    height: 2px;
                    width: 50px;
                    background: #eee;
                    margin: 0 10px;
                }
                /* Date Input Styling */
                input[type="date"] {
                    appearance: none;
                    -webkit-appearance: none;
                    padding: 0.8rem;
                    border: 1px solid #ddd;
                    border-radius: 8px;
                    font-family: 'Inter', sans-serif;
                    font-size: 1rem;
                    color: #333;
                    background: #fff;
                    width: 100%;
                    outline: none;
                    transition: border-color 0.2s;
                }
                input[type="date"]:focus {
                    border-color: var(--primary-color);
                }
            </style>
            
            <form id="saleForm" novalidate>
                <input type="hidden" id="editSaleId">
                <!-- Step 1: Basic Info -->
                <div id="step1" class="step-section">
                    
                    <div id="voiceRecordContainer" style="margin-bottom: 1.5rem; text-align: center;">
                        <button type="button" id="voiceRecordBtn" onclick="toggleRecording()" style="background: var(--card-white); border: 1px solid var(--primary-yellow); color: var(--text-brown); padding: 0.8rem 1.5rem; border-radius: 50px; font-weight: 600; cursor: pointer; display: inline-flex; align-items: center; gap: 0.5rem; transition: all 0.2s; box-shadow: 0 4px 10px rgba(0,0,0,0.05);">
                            <i data-lucide="mic" style="width: 18px; height: 18px;"></i> Preencher com Voz
                        </button>
                    </div>

                    <div class="form-group">
                        <label>Produto</label>
                        <select id="productSelect" required>
                            <option value="">Carregando...</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Quantidade</label>
                        <input type="number" id="quantity" min="1" value="1" required>
                    </div>
                    <div class="form-group">
                        <label>M√©todo de Pagamento</label>
                        <select id="paymentMethod" required onchange="checkPaymentMethod()">
                            <option value="pix">Pix</option>
                            <option value="credit">Cr√©dito</option>
                            <option value="debit">D√©bito</option>
                            <option value="cash">Dinheiro</option>
                            <option value="platform">Plataforma (iFood, 99, etc)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Data</label>
                        <input type="text" id="saleDate" class="date-range-input" placeholder="Selecione a data" required>
                    </div>
                    <button type="button" class="btn-submit" onclick="goToStep2()">Pr√≥ximo</button>
                </div>

                <!-- Step 2: Extra Costs -->
                <div id="step2" class="step-section" style="display: none;">
                    <div class="form-group" style="background: #f9f9f9; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                        <label style="display: flex; align-items: center; justify-content: space-between; cursor: pointer;">
                            <span>Teve Taxa?</span>
                            <input type="checkbox" id="hasFee" onchange="toggleFeeInput()" style="width: auto;">
                        </label>
                        <div id="feeInputContainer" style="display: none; margin-top: 10px;">
                            <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                                <label style="font-weight: normal; display: flex; align-items: center; gap: 5px; cursor: pointer;">
                                    <input type="radio" name="feeType" value="money" checked onchange="updateFeePlaceholder()"> R$ (Valor)
                                </label>
                                <label style="font-weight: normal; display: flex; align-items: center; gap: 5px; cursor: pointer;">
                                    <input type="radio" name="feeType" value="percent" onchange="updateFeePlaceholder()"> % (Porcentagem)
                                </label>
                            </div>
                            <input type="number" id="platformFee" min="0" step="0.01" value="0" placeholder="0.00">
                        </div>
                    </div>

                    <div class="form-group" style="background: #f9f9f9; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                        <label style="display: flex; align-items: center; justify-content: space-between; cursor: pointer;">
                            <span>Voc√™ pagou entrega?</span>
                            <input type="checkbox" id="hasDelivery" onchange="toggleDeliveryInput()" style="width: auto;">
                        </label>
                        <div id="deliveryInputContainer" style="display: none; margin-top: 10px;">
                            <label>Valor da Entrega (R$)</label>
                            <input type="number" id="deliveryFee" min="0" step="0.01" value="0">
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Informa√ß√µes Adicionais (Opcional)</label>
                        <textarea id="saleNotes" maxlength="200" rows="3" placeholder="Ex: Detalhes do pedido..." style="width: 100%; padding: 0.9rem; border: 2px solid #f0f0f0; border-radius: 10px; background: #FAFAFA; resize: vertical; font-family: 'Inter', sans-serif;"></textarea>
                        <div style="text-align: right; font-size: 0.8rem; color: #999;">M√°x. 200 caracteres</div>
                    </div>

                    <div id="debugStatus" style="display:none; background: #333; color: #fff; padding: 10px; border-radius: 5px; margin-bottom: 10px; font-family: monospace; font-size: 0.8rem; white-space: pre-wrap;"></div>
                    
                    <div style="display: flex; gap: 10px;">
                        <button type="button" class="btn-submit" style="background: #ccc; color: #333;" onclick="goToStep1()">Voltar</button>
                        <button type="button" class="btn-submit" onclick="goToSummary()">Ver Resumo</button>
                    </div>
                </div>

                <!-- Step 3: Summary -->
                <div id="stepSummary" class="step-section" style="display: none;">
                    <h4 style="margin-top: 0; color: var(--secondary-caramel);">Resumo da Venda</h4>
                    <div style="background: #FFFBF7; padding: 1rem; border-radius: 8px; border: 1px solid #eee; margin-bottom: 1.5rem;">
                        <p><strong>Produto:</strong> <span id="summaryProduct"></span></p>
                        <p><strong>Quantidade:</strong> <span id="summaryQuantity"></span></p>
                        <p><strong>Total Bruto:</strong> <span id="summaryTotal"></span></p>
                        <p><strong>Taxas:</strong> <span id="summaryFees" style="color: #d32f2f;"></span></p>
                        <p><strong>Custo Vari√°vel:</strong> <span id="summaryVariableCost" style="color: #d32f2f;"></span></p>
                        <p><strong>Entrega:</strong> <span id="summaryDelivery" style="color: #d32f2f;"></span></p>
                        <p id="summaryNotesContainer" style="display:none; font-style: italic; color: #666; margin-top: 5px;"><strong>Notas:</strong> <span id="summaryNotes"></span></p>
                        <hr style="border: 0; border-top: 1px solid #ddd; margin: 10px 0;">
                        <p style="font-size: 1.1rem;"><strong>L√≠quido Estimado:</strong> <span id="summaryNet" style="color: #2E7D32;"></span></p>
                    </div>
                    
                    <div style="display: flex; gap: 10px;">
                        <button type="button" class="btn-submit" style="background: #ccc; color: #333;" onclick="goToStep2()">Voltar</button>
                        <button type="submit" class="btn-submit" style="background: #4CAF50;">Confirmar Venda</button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <style>
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 2000;
            justify-content: center;
            align-items: center;
            padding: 1rem;
            opacity: 0;
            transition: opacity 0.3s;
        }
        .modal-overlay.open {
            display: flex;
            opacity: 1;
        }
        .modal-content {
            width: 100%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            transform: translateY(20px);
            transition: transform 0.3s;
        }
        .modal-overlay.open .modal-content {
            transform: translateY(0);
        }
    </style>

    <script>
        lucide.createIcons();

        // Chart.js Instances (Global - Hoisted to top to avoid TDZ errors)
        let salesChartInstance = null;
        let ticketChartInstance = null;
        let costsChartInstance = null;
        
        // GLOBAL VARIABLES (Fixes TDZ errors)
        let saleDatePicker = null;
        let mediaRecorder = null;
        let audioChunks = [];

        // --- Auth Logic ---
        const urlParams = new URLSearchParams(window.location.search);
        const urlToken = urlParams.get('token');
        if (urlToken) {
            localStorage.setItem('bellecake_token', urlToken);
            window.history.replaceState({}, document.title, window.location.pathname);
        }

        const authToken = localStorage.getItem('bellecake_token');
        if (!authToken) {
            console.warn('No token found');
            window.location.href = '/membros';
        }

        // Wrapper for authenticated requests
        async function authFetch(url, options = {}) {
            const token = localStorage.getItem('bellecake_token');
            console.log('[Auth] Token exists:', !!token); 
            
            const headers = {
                'Content-Type': 'application/json',
                ...options.headers,
                'Authorization': `Bearer ${token}`
            };
            
            // Allow FormData to set its own Content-Type (multipart/form-data with boundary)
            if (options.body instanceof FormData) {
                delete headers['Content-Type'];
            }
            
            try {
                console.log(`[Auth] Fetching ${url}...`);
                const res = await fetch(url, { ...options, headers });
                console.log(`[Auth] Response ${url}:`, res.status);

                if (res.status === 401 || res.status === 403) {
                    console.warn(`[Auth] ${res.status} Error. Redirecting...`);
                    alert('Sess√£o expirada ou inv√°lida. Por favor, acesse via link de membro.');
                    localStorage.removeItem('bellecake_token'); // Clear token
                    window.location.href = '/membros'; 
                    throw new Error('Auth Error');
                }
                return res;
            } catch (err) {
                console.error(`[Auth] Error fetching ${url}:`, err);
                throw err;
            }
        }

        // --- Helper Functions ---
        function formatDateLocal(date) {
            if (!date) return '';
            const d = new Date(date);
            const year = d.getFullYear();
            const month = String(d.getMonth() + 1).padStart(2, '0');
            const day = String(d.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        // Global User Data
        let currentUserData = null;

        // Load User Info
        async function loadUserInfo() {
            try {
                const res = await authFetch('/api/auth/me');
                if (res.ok) {
                    const user = await res.json();
                    console.log('User Data:', user); // DEBUG
                    currentUserData = user; // Store globally
                    const topName = document.getElementById('topUserName');
                    if (topName) {
                        const nameToUse = user.name || user.email || 'Confeiteira';
                        const firstName = nameToUse.trim().split(' ')[0];
                        topName.textContent = 'Ol√°, ' + (firstName || 'Confeiteira');
                    }
                    
                    // Trigger dashboard update to render meta card with user data
                    if(typeof loadDashboard === 'function') loadDashboard();
                }
            } catch (err) {
                console.error('Error loading user info:', err);
            }
        }
        
        loadUserInfo();

        // Initialize saleDate with today's date safely
        const saleDateInput = document.getElementById('saleDate');
        if (saleDateInput) {
            saleDateInput.value = formatDateLocal(new Date());
        }

        // --- Navigation Logic ---
        function switchView(viewId) {
            // Update UI state
            document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
            document.getElementById('view-' + viewId).classList.add('active');

            // Update Menu Active State (Desktop & Mobile)
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            document.querySelectorAll(`.nav-item[onclick*="'${viewId}'"]`).forEach(el => el.classList.add('active'));

            // Close mobile menu if open
            document.getElementById('mobileMenuDropdown').classList.remove('open');
            
            // Refresh data
            if(viewId === 'resumo') loadDashboard();
            if(viewId === 'produtos') loadProductsList(); 
            if(viewId === 'custos') loadFixedCosts();
            if(viewId === 'vendas') {
                loadProducts(); 
                loadRecentSales(); 
            }
        }

        // --- Data Logic ---

        // Helper for Local Date YYYY-MM-DD
        function formatDateLocal(date) {
            if (!date) return '';
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        // Load Products for Selects (Modal & Filter)
        async function loadProducts() {
            try {
                console.log('Loading products...');
                const res = await authFetch('/api/products');
                if (!res.ok) throw new Error('Failed to fetch products');
                const products = await res.json();
                window.productsData = products; // Store globally
                console.log('Products loaded:', products.length);
                
                // 1. Modal Select
                const selectModal = document.getElementById('productSelect');
                if (selectModal) {
                    selectModal.innerHTML = '<option value="">Selecione um produto</option>';
                    products.forEach(p => {
                        selectModal.innerHTML += `<option value="${p._id}">${p.name} - R$ ${p.salePrice.toFixed(2)}</option>`;
                    });
                }

                // 2. Filter Select (Dashboard) - Custom Dropdown
                const dropdownList = document.getElementById('productDropdownList');
                if (dropdownList) {
                    dropdownList.innerHTML = '';
                    
                    // Option: All
                    const divAll = document.createElement('div');
                    divAll.innerText = 'Todos produtos';
                    divAll.style.padding = '10px 15px';
                    divAll.style.cursor = 'pointer';
                    divAll.style.borderBottom = '1px solid #eee';
                    divAll.onmouseover = function() { this.style.background = '#f9f9f9'; };
                    divAll.onmouseout = function() { this.style.background = 'white'; };
                    divAll.onclick = function() { selectProduct('all', 'Todos produtos'); };
                    dropdownList.appendChild(divAll);

                    products.forEach(p => {
                        const div = document.createElement('div');
                        div.innerText = p.name;
                        div.style.padding = '10px 15px';
                        div.style.cursor = 'pointer';
                        div.style.borderBottom = '1px solid #eee';
                        div.onmouseover = function() { this.style.background = '#f9f9f9'; };
                        div.onmouseout = function() { this.style.background = 'white'; };
                        div.onclick = function() { selectProduct(p._id, p.name); };
                        dropdownList.appendChild(div);
                    });
                }

                // 3. Filter Select (Sales - Vendas) - Custom Dropdown
                const dropdownListSales = document.getElementById('productDropdownListSales');
                if (dropdownListSales) {
                    dropdownListSales.innerHTML = '';
                    
                    // Option: All
                    const divAll = document.createElement('div');
                    divAll.innerText = 'Todos produtos';
                    divAll.style.padding = '10px 15px';
                    divAll.style.cursor = 'pointer';
                    divAll.style.borderBottom = '1px solid #eee';
                    divAll.onmouseover = function() { this.style.background = '#f9f9f9'; };
                    divAll.onmouseout = function() { this.style.background = 'white'; };
                    divAll.onclick = function() { selectProductFilterSales('all', 'Todos produtos'); };
                    dropdownListSales.appendChild(divAll);

                    products.forEach(p => {
                        const div = document.createElement('div');
                        div.innerText = p.name;
                        div.style.padding = '10px 15px';
                        div.style.cursor = 'pointer';
                        div.style.borderBottom = '1px solid #eee';
                        div.onmouseover = function() { this.style.background = '#f9f9f9'; };
                        div.onmouseout = function() { this.style.background = 'white'; };
                        div.onclick = function() { selectProductFilterSales(p._id, p.name); };
                        dropdownListSales.appendChild(div);
                    });
                }

            } catch (error) {
                console.error('Error loading products:', error);
                const selectModal = document.getElementById('productSelect');
                if (selectModal) {
                    selectModal.innerHTML = '<option value="">Erro ao carregar produtos</option>';
                }
            }
        }

        // Load Products List (Visual)
        async function loadProductsList() {
            try {
                const res = await authFetch('/api/products');
                const products = await res.json();
                const container = document.getElementById('productsList');
                container.innerHTML = '';
                if(products.length === 0) {
                    container.innerHTML = '<div style="color:#888;">Nenhum produto cadastrado.</div>';
                    return;
                }
                products.forEach(p => {
                    container.innerHTML += `
                        <div style="background: white; padding: 0.8rem; border-radius: 12px; border: 1px solid #eee; box-shadow: 0 2px 5px rgba(0,0,0,0.02); position: relative; display: flex; flex-direction: column; justify-content: space-between;">
                            <div style="position: absolute; top: 8px; left: 8px;">
                                <input type="checkbox" class="product-checkbox" value="${p._id}" onchange="updateProductBulkActions()">
                            </div>
                            <div style="position: absolute; top: 6px; right: 6px; display: flex; gap: 4px;">
                                <button onclick="editProduct('${p._id}', '${p.name.replace(/'/g, "\\'")}', ${p.variableCost}, ${p.salePrice})" style="background: none; border: none; color: #CD7A3E; cursor: pointer; padding: 4px;" title="Editar Produto">
                                    <i data-lucide="edit-2" style="width: 16px; height: 16px;"></i>
                                </button>
                                <button onclick="deleteProduct('${p._id}')" style="background: none; border: none; color: #999; cursor: pointer; padding: 4px;" title="Remover Produto">
                                    <i data-lucide="trash-2" style="width: 16px; height: 16px;"></i>
                                </button>
                            </div>
                            <div style="font-weight: 700; color: var(--text-brown); margin-bottom: 0.5rem; padding-right: 60px; padding-left: 25px; line-height: 1.2; font-size: 0.95rem;">${p.name}</div>
                            <div style="display:flex; justify-content:space-between; font-size: 0.85rem; padding-left: 25px; align-items: flex-end;">
                                <div style="display: flex; flex-direction: column;">
                                    <span style="color: #888; font-size: 0.75rem;">Custo</span>
                                    <span style="color: #666; font-weight: 600;">
                                        <span style="font-size: 0.8em; color: #999; font-weight: 400;">(${p.salePrice > 0 ? ((p.variableCost/p.salePrice)*100).toFixed(0) : 0}%)</span> 
                                        R$ ${p.variableCost.toFixed(2)}
                                    </span>
                                </div>
                                <div style="display: flex; flex-direction: column; text-align: right;">
                                    <span style="color: #888; font-size: 0.75rem;">Venda</span>
                                    <span style="color: #4CAF50; font-weight:700;">R$ ${p.salePrice.toFixed(2)}</span>
                                </div>
                            </div>
                        </div>
                    `;
                });
                lucide.createIcons();
            } catch (error) {
                console.error('Error loading products list:', error);
            }
        }

        // Set Sales Period
        function setSalesPeriod(period) {
            const now = new Date();
            let start, end;
            
            // Remove active class from all buttons
            document.querySelectorAll('.sales-preset').forEach(btn => btn.classList.remove('active'));
            
            // Add active class to clicked button
            const activeBtn = document.querySelector(`.sales-preset[onclick="setSalesPeriod('${period}')"]`);
            if (activeBtn) activeBtn.classList.add('active');

            switch(period) {
                case 'today':
                    start = now;
                    end = now;
                    break;
                case 'yesterday':
                    start = new Date(now);
                    start.setDate(now.getDate() - 1);
                    end = new Date(now);
                    end.setDate(now.getDate() - 1);
                    break;
                case '7days':
                    start = new Date(now);
                    start.setDate(now.getDate() - 6);
                    end = now;
                    break;
                case '30days':
                    start = new Date(now);
                    start.setDate(now.getDate() - 29);
                    end = now;
                    break;
                case 'thismonth':
                    start = new Date(now.getFullYear(), now.getMonth(), 1);
                    end = new Date(now.getFullYear(), now.getMonth() + 1, 0);
                    break;
            }

            if (datePickerSales) {
                datePickerSales.setDate([start, end]);
            }
            
            loadRecentSales();
        }

        // Load Recent Sales
        async function loadRecentSales() {
            const tbody = document.getElementById('salesTableBody');
            if(!tbody) return;

            tbody.innerHTML = '<tr><td colspan="6" style="padding:2rem; text-align:center;"><i data-lucide="loader-2" class="spin"></i> Carregando vendas...</td></tr>';
            if (typeof lucide !== 'undefined') lucide.createIcons();

            try {
                // Get Product Filter
                const productSelect = document.getElementById('filterProductSales');
                const productId = productSelect ? productSelect.value : 'all';
                
                // Get Date Range
                let query = '?limit=100'; // Default limit
                
                if (typeof datePickerSales !== 'undefined' && datePickerSales && datePickerSales.selectedDates.length > 0) {
                    let start = datePickerSales.selectedDates[0];
                    let end = datePickerSales.selectedDates[1] || start; // Handle single date or range
                    
                    // Adjust to include full day (Local Time -> ISO)
                    // This matches loadDashboard logic to ensure consistency
                    const s = new Date(start); s.setHours(0,0,0,0);
                    const e = new Date(end); e.setHours(23,59,59,999);
                    
                    query += `&startDate=${s.toISOString()}&endDate=${e.toISOString()}`;
                } else {
                    // Fallback to 30 days if no date selected
                     const end = new Date();
                     const start = new Date();
                     start.setDate(end.getDate() - 30);
                     start.setHours(0,0,0,0);
                     end.setHours(23,59,59,999);
                     
                     // Set picker to this default so UI matches
                     if(typeof datePickerSales !== 'undefined' && datePickerSales) {
                         datePickerSales.setDate([start, end]);
                     }
                     query += `&startDate=${start.toISOString()}&endDate=${end.toISOString()}`;
                }
                
                if (productId && productId !== 'all') {
                    query += `&productId=${productId}`;
                }
                
                console.log('Loading sales with query:', query);
                const res = await authFetch(`/api/sales${query}`); 
                if (!res.ok) throw new Error('Falha ao buscar vendas');

                const sales = await res.json();
                window.recentSalesData = sales; // Store globally for edit functionality
                
                tbody.innerHTML = '';
                
                if(sales.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" style="padding:1rem; text-align:center; color:#888;">Nenhuma venda encontrada neste per√≠odo.</td></tr>';
                    return;
                }

                sales.forEach(s => { 
                    const productName = s.product ? s.product.name : 'Produto removido';
                    const paymentMap = { pix: 'Pix', credit: 'Cr√©dito', debit: 'D√©bito', cash: 'Dinheiro', platform: 'Plataforma' };
                    
                    // Format date for display
                    const dateObj = new Date(s.date);
                    const formattedDate = dateObj.toLocaleDateString('pt-BR') + ' ' + dateObj.toLocaleTimeString('pt-BR', {hour: '2-digit', minute:'2-digit'});

                    tbody.innerHTML += `
                        <tr style="border-bottom: 1px solid #eee;">
                            <td data-label="Data" style="padding: 1rem;"><span class="cell-content">${formattedDate}</span></td>
                            <td data-label="Produto" style="padding: 1rem; font-weight: 500;"><span class="cell-content">${productName}</span></td>
                            <td data-label="Qtd" style="padding: 1rem;"><span class="cell-content">${s.quantity}</span></td>
                            <td data-label="Pagamento" style="padding: 1rem;">
                                <span class="cell-content" style="background: #f0f0f0; padding: 2px 8px; border-radius: 4px; font-size: 0.85rem;">
                                    ${paymentMap[s.paymentMethod] || s.paymentMethod}
                                </span>
                            </td>
                            <td data-label="Valor" style="padding: 1rem; color: #4CAF50; font-weight: 600;"><span class="cell-content">R$ ${s.totalAmount.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}</span></td>
                            <td data-label="Lucro" style="padding: 1rem; color: #2E7D32; font-weight: 600;"><span class="cell-content">R$ ${(s.profit || 0).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}</span></td>
                            <td data-label="A√ß√µes" style="padding: 1rem; text-align: right;">
                                <div class="cell-content" style="display: flex; gap: 8px; justify-content: flex-end;">
                                    <button onclick="editSale('${s._id}')" style="background: none; border: none; color: #CD7A3E; cursor: pointer; padding: 4px;" title="Editar Venda">
                                        <i data-lucide="edit-2" style="width: 16px; height: 16px;"></i>
                                    </button>
                                    <button onclick="deleteSale('${s._id}')" style="background: none; border: none; color: #F44336; cursor: pointer; padding: 4px;" title="Excluir Venda">
                                        <i data-lucide="trash-2" style="width: 16px; height: 16px;"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                    `;
                });
                lucide.createIcons();
            } catch (error) {
                console.error('Error loading sales list:', error);
                tbody.innerHTML = `<tr><td colspan="6" style="padding:2rem; text-align:center; color:red;">Erro ao carregar vendas: ${error.message}</td></tr>`;
            }
        }

        // Modal Logic
        // saleDatePicker is defined globally

        async function openSaleModal() {
            console.log('Opening sale modal...');
            const modal = document.getElementById('newSaleModal');
            if (modal) {
                 modal.classList.add('open');
            } else {
                console.error('Modal element not found!');
                alert('Erro interno: Modal n√£o encontrado.');
                return;
            }

            try {
                // Show loading state in select
                const selectModal = document.getElementById('productSelect');
                if (selectModal) selectModal.innerHTML = '<option value="">Carregando produtos...</option>';

                await loadProducts(); // Refresh products
                
                // Init Flatpickr if not exists
                if (!saleDatePicker) {
                    const dateEl = document.getElementById("saleDate");
                    if (dateEl) {
                        saleDatePicker = flatpickr(dateEl, {
                            dateFormat: "Y-m-d",
                            locale: "pt",
                            altInput: true,
                            altFormat: "d/m/Y",
                            defaultDate: new Date()
                        });
                    }
                } else {
                    saleDatePicker.setDate(new Date());
                }

                // Reset Edit Mode
                document.getElementById('editSaleId').value = '';
                document.querySelector('#newSaleModal h3').innerText = 'Nova Venda';
                const submitBtn = document.querySelector('#saleForm button[type="submit"]');
                if(submitBtn) {
                    submitBtn.innerText = 'Confirmar Venda';
                    submitBtn.disabled = false;
                }

                resetVoiceUI();
                goToStep1(); // Ensure we start at step 1
            } catch (err) {
                console.error('Error in openSaleModal:', err);
                alert('Erro ao abrir modal de venda.');
            }
        }


        function closeSaleModal() {
            document.getElementById('newSaleModal').classList.remove('open');
            if (mediaRecorder && mediaRecorder.state === 'recording') {
                stopRecording();
            }
        }

        // --- Voice Recording Logic ---
        // mediaRecorder and audioChunks are defined globally

        function resetVoiceUI() {
            const btn = document.getElementById('voiceRecordBtn');
            const status = document.getElementById('voiceStatus');
            if (btn) {
                btn.classList.remove('recording');
                btn.innerHTML = '<i data-lucide="mic" style="width: 18px; height: 18px;"></i> Preencher com Voz';
            }
            if (status) {
                status.style.display = 'none';
                status.innerText = '';
            }
            lucide.createIcons();
        }

        async function toggleRecording() {
            const btn = document.getElementById('voiceRecordBtn');
            const status = document.getElementById('voiceStatus');

            if (!mediaRecorder || mediaRecorder.state === 'inactive') {
                // Start Recording
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    
                    // Detect supported MIME type
                    let mimeType = 'audio/webm'; // default
                    if (MediaRecorder.isTypeSupported('audio/webm;codecs=opus')) {
                        mimeType = 'audio/webm;codecs=opus';
                    } else if (MediaRecorder.isTypeSupported('audio/mp4')) {
                        mimeType = 'audio/mp4'; // Safari often uses this
                    } else if (MediaRecorder.isTypeSupported('audio/aac')) {
                        mimeType = 'audio/aac';
                    }

                    mediaRecorder = new MediaRecorder(stream, { mimeType });
                    audioChunks = [];

                    mediaRecorder.ondataavailable = event => {
                        if (event.data.size > 0) {
                            audioChunks.push(event.data);
                        }
                    };

                    mediaRecorder.onstop = async () => {
                        // Use the actual mimeType from the recorder
                        const type = mediaRecorder.mimeType || mimeType;
                        const audioBlob = new Blob(audioChunks, { type: type });
                        await processAudio(audioBlob);
                        stream.getTracks().forEach(track => track.stop()); // Stop mic
                    };

                    mediaRecorder.start();
                    btn.classList.add('recording');
                    btn.innerHTML = '<i data-lucide="square" style="width: 18px; height: 18px;"></i> Parar Grava√ß√£o';
                    btn.style.background = '#F44336';
                    btn.style.color = 'white';
                    status.style.display = 'block';
                    status.innerText = 'Gravando... Fale os detalhes da venda.';
                    status.style.color = '#F44336';
                    lucide.createIcons();

                } catch (err) {
                    console.error('Error accessing microphone:', err);
                    alert('Erro ao acessar microfone. Verifique as permiss√µes.');
                }
            } else {
                // Stop Recording
                mediaRecorder.stop();
                btn.classList.remove('recording');
                btn.innerHTML = '<i data-lucide="loader-2" style="width: 18px; height: 18px; animation: spin 1s linear infinite;"></i> Processando...';
                btn.style.background = '#eee';
                btn.style.color = '#666';
                status.innerText = 'Transcrevendo e analisando...';
                status.style.color = '#666';
                lucide.createIcons();
            }
        }

        async function processAudio(blob) {
            const formData = new FormData();
            
            // Determine extension based on blob type
            let ext = 'webm';
            if (blob.type.includes('mp4')) ext = 'mp4';
            else if (blob.type.includes('aac')) ext = 'm4a'; // Map AAC to M4A for OpenAI compatibility
            else if (blob.type.includes('wav')) ext = 'wav';
            
            formData.append('audio', blob, `recording.${ext}`);

            try {
                const res = await authFetch('/api/transcribe', {
                    method: 'POST',
                    body: formData,
                    headers: {} // Let browser set boundary
                });

                if (!res.ok) {
                    const errData = await res.json().catch(() => ({}));
                    throw new Error(errData.details || errData.error || 'Transcription failed');
                }

                const data = await res.json();
                console.log('Transcription result:', data);

                fillFormFromVoice(data.parsedData);
                
                const status = document.getElementById('voiceStatus');
                status.innerText = `Entendido: "${data.text}"`;
                status.style.color = '#4CAF50';
                
                // Reset button
                const btn = document.getElementById('voiceRecordBtn');
                btn.innerHTML = '<i data-lucide="mic" style="width: 18px; height: 18px;"></i> Preencher com Voz';
                btn.style.background = ''; // Reset to default CSS
                btn.style.color = '';
                lucide.createIcons();

            } catch (err) {
                console.error('Processing error:', err);
                const status = document.getElementById('voiceStatus');
                status.innerText = `Erro: ${err.message}. Verifique a API Key.`;
                status.style.color = '#F44336';
                
                const btn = document.getElementById('voiceRecordBtn');
                btn.innerHTML = '<i data-lucide="mic" style="width: 18px; height: 18px;"></i> Tentar Novamente';
                btn.style.background = '';
                btn.style.color = '';
                lucide.createIcons();
            }
        }

        function fillFormFromVoice(data) {
            if (!data) return;

            // 1. Product
            const select = document.getElementById('productSelect');
            if (data.productName) {
                // Fuzzy match or exact match
                // API tries to match exact name from list we sent
                // We'll iterate options to find best match
                let found = false;
                for (let i = 0; i < select.options.length; i++) {
                    if (select.options[i].text.includes(data.productName)) {
                        select.selectedIndex = i;
                        found = true;
                        break;
                    }
                }
                if (!found) console.warn('Product not found in list:', data.productName);
            }

            // 2. Quantity
            if (data.quantity) {
                document.getElementById('quantity').value = data.quantity;
            }

            // 3. Payment Method
            if (data.paymentMethod) {
                // Map API "pix", "credit", "debit", "cash" to select values if they differ
                // Current HTML select values are likely lower case
                const methodSelect = document.getElementById('paymentMethod');
                if (methodSelect) {
                    methodSelect.value = data.paymentMethod.toLowerCase();
                }
            }

            // 4. Date
            if (data.date) {
                if(saleDatePicker) {
                    saleDatePicker.setDate(data.date);
                } else {
                    document.getElementById('saleDate').value = data.date;
                }
            }
        }


        // Close modal on outside click
        document.getElementById('newSaleModal').addEventListener('click', (e) => {
            if (e.target.id === 'newSaleModal') closeSaleModal();
        });

        // Load Fixed Costs
        async function loadFixedCosts() {
            try {
                const res = await authFetch('/api/fixed-costs?period=this_month');
                const costs = await res.json();
                
                // Sort by amount (descending) -> implies percentage descending
                costs.sort((a, b) => b.amount - a.amount);

                const container = document.getElementById('fixedCostsList');
                const totalEl = document.getElementById('viewCustosTotal');
                
                container.innerHTML = '';
                
                let total = 0;
                costs.forEach(c => total += c.amount);

                if(costs.length === 0) {
                    container.innerHTML = '<div style="color:#888;">Nenhum custo registrado neste m√™s.</div>';
                    if(totalEl) totalEl.innerText = 'R$ 0,00';
                    return;
                }
                
                costs.forEach(c => {
                    // Ensure ID is safe string
                    const safeId = c._id || '';
                    if (!safeId) console.error('Cost without ID:', c);

                    const percent = total > 0 ? ((c.amount / total) * 100).toFixed(1) : 0;

                    container.innerHTML += `
                        <div style="background: white; padding: 0.5rem 0.8rem; border-radius: 10px; border: 1px solid #eee; box-shadow: 0 1px 3px rgba(0,0,0,0.02); position: relative; display: flex; flex-direction: column; justify-content: center; min-height: 60px;">
                            <div style="position: absolute; top: 8px; left: 8px;">
                                <input type="checkbox" class="cost-checkbox" value="${safeId}" onchange="updateBulkActions()">
                            </div>
                            <div style="position: absolute; top: 6px; right: 6px; display: flex; gap: 4px;">
                                <button onclick="editFixedCost('${safeId}', '${c.name.replace(/'/g, "\\'")}', ${c.amount}, '${c.recurrenceType}', ${c.installments || 1}, '${c.date}')" style="background: none; border: none; color: #CD7A3E; cursor: pointer; padding: 4px;" title="Editar Custo">
                                    <i data-lucide="edit-2" style="width: 16px; height: 16px;"></i>
                                </button>
                                <button onclick="deleteFixedCost('${safeId}')" style="background: none; border: none; color: #999; cursor: pointer; padding: 4px;" title="Remover Custo">
                                    <i data-lucide="x" style="width: 16px; height: 16px;"></i>
                                </button>
                            </div>
                            <div style="font-weight: 700; color: var(--text-brown); margin-bottom: 0.2rem; padding-right: 60px; padding-left: 25px; word-break: break-word; line-height: 1.1; font-size: 0.9rem;">${c.name}</div>
                            <div style="display:flex; justify-content:space-between; font-size: 0.85rem; padding-left: 25px; align-items: flex-end;">
                                <span style="color: #666; font-size: 0.75rem; text-transform: capitalize;">${new Date(c.date).toLocaleDateString('pt-BR', { day: '2-digit', month: 'short', year: 'numeric' })}</span>
                                <div style="text-align: right;">
                                    <span style="color: #F44336; font-weight:600; display: block; font-size: 0.95rem;">R$ ${c.amount.toFixed(2)}</span>
                                    <span style="font-size: 0.7rem; color: #999;">${percent}% do total</span>
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                if(totalEl) totalEl.innerText = total.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
                lucide.createIcons();
                
            } catch (error) {
                console.error('Error loading fixed costs:', error);
            }
        }

        // Bulk Actions Logic for Products
        function toggleSelectAllProducts() {
            const checked = document.getElementById('selectAllProducts').checked;
            document.querySelectorAll('.product-checkbox').forEach(cb => cb.checked = checked);
            updateProductBulkActions();
        }

        function updateProductBulkActions() {
            const count = document.querySelectorAll('.product-checkbox:checked').length;
            const actionDiv = document.getElementById('productBulkActions');
            if (count > 0) {
                actionDiv.style.display = 'flex';
                actionDiv.querySelector('button').innerHTML = `<i data-lucide="trash-2" style="width: 16px; height: 16px; vertical-align: middle;"></i> Remover Selecionados (${count})`;
                lucide.createIcons();
            } else {
                actionDiv.style.display = 'none';
            }
        }

        async function deleteSelectedProducts() {
            const selected = Array.from(document.querySelectorAll('.product-checkbox:checked')).map(cb => cb.value);
            if (selected.length === 0) return;
            
            if (!confirm(`Tem certeza que deseja remover ${selected.length} produtos selecionados?`)) return;

            let successCount = 0;
            const btn = document.querySelector('#productBulkActions button');
            const originalText = btn.innerHTML;
            btn.innerHTML = 'Removendo...';
            btn.disabled = true;

            try {
                for (const id of selected) {
                    try {
                        const res = await authFetch(`/api/products/${id}`, { method: 'DELETE' });
                        if (res.ok) successCount++;
                    } catch (e) {
                        console.error('Failed to delete product', id, e);
                    }
                }
                alert(`${successCount} produtos removidos com sucesso!`);
                loadProductsList();
                loadProducts(); // Refresh select
                document.getElementById('selectAllProducts').checked = false;
            } catch (err) {
                alert('Erro ao processar remo√ß√£o em massa.');
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }

        // Bulk Actions Logic for Costs
        function toggleSelectAllCosts() {
            const checked = document.getElementById('selectAllCosts').checked;
            document.querySelectorAll('.cost-checkbox').forEach(cb => cb.checked = checked);
            updateBulkActions();
        }

        function updateBulkActions() {
            const count = document.querySelectorAll('.cost-checkbox:checked').length;
            const actionDiv = document.getElementById('bulkActions');
            if (count > 0) {
                actionDiv.style.display = 'flex';
                actionDiv.querySelector('button').innerHTML = `<i data-lucide="trash-2" style="width: 16px; height: 16px; vertical-align: middle;"></i> Remover Selecionados (${count})`;
                lucide.createIcons();
            } else {
                actionDiv.style.display = 'none';
            }
        }

        async function deleteSelectedCosts() {
            const selected = Array.from(document.querySelectorAll('.cost-checkbox:checked')).map(cb => cb.value);
            if (selected.length === 0) return;
            
            if (!confirm(`Tem certeza que deseja remover ${selected.length} custos selecionados?`)) return;

            // Simple loop for now (could be optimized with bulk API)
            let successCount = 0;
            const btn = document.querySelector('#bulkActions button');
            const originalText = btn.innerHTML;
            btn.innerHTML = 'Removendo...';
            btn.disabled = true;

            try {
                // Execute sequentially to avoid overwhelming if many
                for (const id of selected) {
                    try {
                        const res = await authFetch(`/api/fixed-costs/${id}`, { method: 'DELETE' });
                        if (res.ok) successCount++;
                    } catch (e) {
                        console.error('Failed to delete', id, e);
                    }
                }
                alert(`${successCount} custos removidos com sucesso!`);
                loadFixedCosts();
                loadDashboard();
                document.getElementById('selectAllCosts').checked = false;
            } catch (err) {
                alert('Erro ao processar remo√ß√£o em massa.');
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }

        // Delete Fixed Cost
        async function deleteFixedCost(id) {
            console.log('Deleting cost ID:', id);
            if (!id) {
                alert('Erro: ID do custo inv√°lido.');
                return;
            }
            if (!confirm('Tem certeza que deseja remover este custo fixo?')) return;
            
            try {
                const res = await authFetch(`/api/fixed-costs/${id}`, {
                    method: 'DELETE'
                });
                
                if (res.ok) {
                    loadFixedCosts();
                    loadDashboard(); // Update dashboard totals too
                } else {
                    const data = await res.json();
                    console.error('Delete error:', data);
                    alert('Erro ao remover custo: ' + (data.error || 'Erro desconhecido'));
                }
            } catch (error) {
                console.error('Error deleting cost:', error);
                alert('Erro ao processar remo√ß√£o.');
            }
        }

        // --- Date Filter Logic ---
        let datePicker;
        let datePickerSales;
        
        document.addEventListener('DOMContentLoaded', () => {
            // Mobile Menu Toggle
            const mobileMenuBtn = document.getElementById('mobileMenuBtn');
            const mobileMenuDropdown = document.getElementById('mobileMenuDropdown');
            if(mobileMenuBtn && mobileMenuDropdown) {
                mobileMenuBtn.addEventListener('click', (e) => {
                    e.stopPropagation(); // Prevent bubbling
                    mobileMenuDropdown.classList.toggle('open');
                    if (typeof lucide !== 'undefined') lucide.createIcons();
                });
                
                // Close menu when clicking outside
                document.addEventListener('click', (e) => {
                    if (mobileMenuDropdown.classList.contains('open') && 
                        !mobileMenuBtn.contains(e.target) && 
                        !mobileMenuDropdown.contains(e.target)) {
                        mobileMenuDropdown.classList.remove('open');
                    }
                });
            }

            // Init Flatpickr
            datePicker = flatpickr("#filterDateRange", {
                mode: "range",
                dateFormat: "Y-m-d",
                locale: "pt",
                altInput: true,
                altFormat: "d/m/Y",
                onChange: function(selectedDates, dateStr, instance) {
                    // Auto-filter when range is selected (wait for both dates if range)
                    if (selectedDates.length === 2 || (selectedDates.length === 1 && instance.config.mode !== 'range')) {
                        loadDashboard();
                    }
                }
            });

            // Default to Today for Resumo
            const todayResumo = new Date();
            const startOfDayResumo = new Date(todayResumo);
            startOfDayResumo.setHours(0,0,0,0);
            todayResumo.setHours(23,59,59,999); // Ensure end of day
            datePicker.setDate([startOfDayResumo, todayResumo]);

            // Init Flatpickr for Sales (Vendas Tab)
            const salesRangeInput = document.getElementById("filterDateRangeSales");
            if (salesRangeInput) {
                datePickerSales = flatpickr("#filterDateRangeSales", {
                    mode: "range",
                    dateFormat: "Y-m-d",
                    locale: "pt",
                    altInput: true,
                    altFormat: "d/m/Y",
                    onChange: function(selectedDates, dateStr, instance) {
                        if (selectedDates.length === 2 || (selectedDates.length === 1 && instance.config.mode !== 'range')) {
                            loadRecentSales();
                            // Clear active presets
                            document.querySelectorAll('.period-preset-sales').forEach(b => b.classList.remove('active'));
                        }
                    }
                });
                
                // Default to Today for Sales
                const today = new Date();
                const startOfDay = new Date(today);
                startOfDay.setHours(0,0,0,0);
                
                datePickerSales.setDate([startOfDay, today]);
            }

            // Product Filter Auto-update
            const productFilter = document.getElementById('filterProduct');
            if(productFilter) {
                productFilter.addEventListener('change', loadDashboard);
            }
            
            // Product Filter Auto-update (Sales)
            const productFilterSales = document.getElementById('filterProductSales');
            if(productFilterSales) {
                productFilterSales.addEventListener('change', loadRecentSales);
            }

            // Set default to "Today" for Dashboard
            const now = new Date();
            const startOfToday = new Date(now);
            startOfToday.setHours(0,0,0,0);
            datePicker.setDate([startOfToday, now]);
            
            // Initial Load
            loadProducts(); // Load products for filter
            loadDashboard();
            loadRecentSales();
        });

        // Apply Filters Button
        const btnApply = document.getElementById('btnApplyFilters');
        if(btnApply) btnApply.addEventListener('click', loadDashboard);
        
        // Apply Filters Button Sales
        const btnApplySales = document.getElementById('btnApplyFiltersSales');
        if(btnApplySales) btnApplySales.addEventListener('click', loadRecentSales);

        // Period Presets
        document.querySelectorAll('.period-preset').forEach(btn => {
            btn.addEventListener('click', (e) => {
                // Update active class
                document.querySelectorAll('.period-preset').forEach(b => b.classList.remove('active'));
                e.target.classList.add('active');

                const period = e.target.dataset.period;
                const end = new Date(); // Current time
                let start = new Date();

                if (period === 'today') {
                    // Start of day to End of day
                    start = new Date(); 
                    start.setHours(0,0,0,0);
                    // Fixed: end was const, causing assignment error
                    end.setHours(23,59,59,999);
                } else if (period === 'yesterday') {
                    start.setDate(end.getDate() - 1);
                    start.setHours(0,0,0,0);
                    end.setDate(end.getDate() - 1);
                    end.setHours(23,59,59,999);
                } else if (period === '7days') {
                    start.setDate(end.getDate() - 6); // 7 days including today
                    start.setHours(0,0,0,0);
                } else if (period === '30days') {
                    start.setDate(end.getDate() - 29); // 30 days including today
                    start.setHours(0,0,0,0);
                } else if (period === 'thismonth') {
                    start = new Date(end.getFullYear(), end.getMonth(), 1);
                }

                // Set dates in picker (handles visual + state)
                if(datePicker) {
                    datePicker.setDate([start, end]);
                } else {
                    console.error('DatePicker not initialized');
                }
                
                // Trigger dashboard reload immediately
                loadDashboard();
            });
        });



        function setSalesPeriod(period) {
            // Update UI
            document.querySelectorAll('.sales-preset').forEach(b => b.classList.remove('active'));
            const btn = document.querySelector(`.sales-preset[data-period="${period}"]`);
            if(btn) btn.classList.add('active');
            
            const end = new Date();
            let start = new Date();
            
            if (period === 'today') {
                start.setHours(0,0,0,0);
                end.setHours(23,59,59,999);
            } else if (period === 'yesterday') {
                start.setDate(end.getDate() - 1);
                start.setHours(0,0,0,0);
                end.setDate(end.getDate() - 1);
                end.setHours(23,59,59,999);
            } else if (period === '7days') {
                start.setDate(end.getDate() - 6);
                start.setHours(0,0,0,0);
            } else if (period === '30days') {
                start.setDate(end.getDate() - 29);
                start.setHours(0,0,0,0);
            } else if (period === 'all') {
                start = new Date(2020, 0, 1);
            }

            if(datePickerSales) {
                datePickerSales.setDate([start, end]);
            } else {
                // Fallback if picker not ready? 
                // We should try to reload anyway, loadRecentSales checks picker, but if picker is null it defaults to no date filter?
                // Wait, if picker is null, loadRecentSales sends no date query.
                // We should manually trigger loadRecentSales if picker is missing, but dates won't be respected unless we pass them.
                // But datePickerSales should be ready.
                loadRecentSales();
            }
            // Note: onChange of picker calls loadRecentSales, so setting date triggers it automatically if configured.
            // But if we call setDate on flatpickr with triggerChange=true (default is false usually?), let's check.
            // Flatpickr setDate(date, triggerChange, format)
            // If we want to trigger, we pass true.
            // But let's just call loadRecentSales explicitly if we want to be sure, or rely on callback.
            // Lines 2185 callback calls loadRecentSales.
            // Let's rely on callback or call it.
            // Safer to call it explicitly if callback is not reliable or if setDate doesn't trigger.
            // By default setDate does NOT trigger onChange.
            loadRecentSales(); 
        }

        // Load Dashboard Data
        function updateBreakEvenCard(revenue, fixedCost, variableCost, goalMetDate) {
            const totalCost = fixedCost + variableCost;
            // Allow percentage to go above 100%
            const percentage = totalCost > 0 ? (revenue / totalCost) * 100 : (revenue > 0 ? 100 : 0);
            
            const goalEl = document.getElementById('beGoalValue');
            const currentEl = document.getElementById('beCurrentValue');
            const percentageEl = document.getElementById('bePercentage');
            const progressBar = document.getElementById('beProgressBar');
            const card = document.getElementById('breakEvenGoalCard');
            const datesEl = document.getElementById('beDates');

            if (goalEl) goalEl.innerText = totalCost.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
            if (currentEl) currentEl.innerText = revenue.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
            if (percentageEl) percentageEl.innerText = percentage.toFixed(1) + '%';
            if (progressBar) progressBar.style.width = Math.min(percentage, 100) + '%';
            
            // Add Date Info
            const todayStr = new Date().toLocaleDateString('pt-BR');
            let metaText = `Hoje: ${todayStr}`;
            
            if (goalMetDate) {
                const metDate = new Date(goalMetDate);
                metaText += ` | Meta batida em: ${metDate.toLocaleDateString('pt-BR')}`;
            } else if (percentage >= 100) {
                 metaText += ` | Meta batida!`;
            }

            if (!datesEl) {
                const datesDiv = document.createElement('div');
                datesDiv.id = 'beDates';
                datesDiv.style.marginTop = '10px';
                datesDiv.style.fontSize = '0.85rem';
                datesDiv.style.color = '#666';
                datesDiv.style.display = 'flex';
                datesDiv.style.justifyContent = 'space-between';
                datesDiv.innerText = metaText;
                if(progressBar && progressBar.parentElement) {
                    progressBar.parentElement.parentElement.appendChild(datesDiv);
                }
            } else {
                datesEl.innerText = metaText;
            }
            
            if (card) card.style.display = 'block';
        }

        async function loadDashboard() {
            const loader = document.getElementById('dashboardLoading');
            try {
                if(loader) loader.style.display = 'block';
                // Get Product
                const productSelect = document.getElementById('filterProduct');
                const productId = productSelect ? productSelect.value : 'all';

                // Get Dates from Flatpickr
                const selectedDates = datePicker ? datePicker.selectedDates : [];
                let query = '';
                
                if (selectedDates.length > 0) {
                    let start = selectedDates[0];
                    let end = selectedDates.length > 1 ? selectedDates[1] : start;
                    
                    // Adjust to include full day (Local Time)
                    const s = new Date(start); s.setHours(0,0,0,0);
                    const e = new Date(end); e.setHours(23,59,59,999);
                    
                    query = `?start=${s.toISOString()}&end=${e.toISOString()}`;
                } else {
                    // Default to This Month
                    const now = new Date();
                    const s = new Date(now.getFullYear(), now.getMonth(), 1); s.setHours(0,0,0,0);
                    const e = new Date(now.getFullYear(), now.getMonth() + 1, 0); e.setHours(23,59,59,999);
                    query = `?start=${s.toISOString()}&end=${e.toISOString()}`;
                }

                if (productId && productId !== 'all') {
                    query += `&productId=${productId}`;
                }

                console.log('Loading Dashboard with query:', query);

                const res = await authFetch(`/api/dashboard/stats${query}`);
                if (!res.ok) {
                    const errData = await res.json().catch(() => ({}));
                    throw new Error(errData.details || errData.error || 'Falha ao carregar dados: ' + res.status);
                }
                
                const data = await res.json();
                
                const stats = data.summary;

                if (document.getElementById('totalSales')) document.getElementById('totalSales').innerText = stats.totalRevenue.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
                if (document.getElementById('totalVariableCost')) document.getElementById('totalVariableCost').innerText = stats.totalVariableCost.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
                if (document.getElementById('totalFixedCostDash')) document.getElementById('totalFixedCostDash').innerText = stats.totalFixedCost.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
                if (document.getElementById('totalProfit')) document.getElementById('totalProfit').innerText = stats.netProfit.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
                if (document.getElementById('ticketAvg')) document.getElementById('ticketAvg').innerText = stats.ticketAverage.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
                if (document.getElementById('totalItems')) document.getElementById('totalItems').innerText = stats.salesCount;
                
                if (data.charts) updateCharts(data.charts);
                if (stats.topProducts) updateTopProducts(stats.topProducts);
                
                const monthly = data.monthlyStats;
                updateBreakEvenCard(monthly.totalRevenue, monthly.totalFixedCost, monthly.totalVariableCost, monthly.goalMetDate);
            } catch (error) {
                console.error('Error loading dashboard:', error);
                if(document.getElementById('totalSales')) {
                    document.getElementById('totalSales').innerText = 'Erro';
                    document.getElementById('totalSales').title = error.message; // Show details on hover
                    
                    // Also show a toast or alert for better visibility if it's a specific error
                    const kpiCards = document.querySelectorAll('.kpi-value');
                    kpiCards.forEach(el => {
                        el.innerText = 'Erro';
                        el.style.color = 'red';
                    });
                    
                    // Show error in the container
                    const container = document.querySelector('.header-dash');
                    let errDiv = document.getElementById('dashErrorMsg');
                    if(!errDiv) {
                        errDiv = document.createElement('div');
                        errDiv.id = 'dashErrorMsg';
                        errDiv.style.color = 'red';
                        errDiv.style.background = '#ffebee';
                        errDiv.style.padding = '1rem';
                        errDiv.style.borderRadius = '8px';
                        errDiv.style.marginTop = '1rem';
                        errDiv.style.width = '100%';
                        container.appendChild(errDiv);
                    }
                    errDiv.innerText = `Erro ao carregar dados: ${error.message}`;
                    errDiv.style.display = 'block';
                }
            } finally {
                if(loader) loader.style.display = 'none';
            }
        }
        
        function updateTopProducts(products) {
            const tbody = document.getElementById('topProductsTable');
            tbody.innerHTML = '';
            
            if (!products || products.length === 0) {
                tbody.innerHTML = '<tr><td colspan="3" style="padding:1rem; text-align:center; color:#888;">Nenhum produto vendido no per√≠odo.</td></tr>';
                return;
            }

            products.forEach(p => {
                tbody.innerHTML += `
                    <tr style="border-bottom: 1px solid #eee;">
                        <td style="padding: 1rem; font-weight: 500;">${p.name}</td>
                        <td style="padding: 1rem;">${p.quantity}</td>
                        <td style="padding: 1rem; color: var(--secondary-caramel); font-weight: 600;">R$ ${p.revenue.toFixed(2)}</td>
                    </tr>
                `;
            });
        }

        // Register Product (Create/Update)
        document.getElementById('productForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = e.target.querySelector('button');
            const originalText = btn.innerText;
            btn.innerText = 'Salvando...';
            btn.disabled = true;

            const editId = document.getElementById('editProductId').value;
            const data = {
                name: document.getElementById('prodName').value,
                variableCost: parseFloat(document.getElementById('prodCost').value),
                salePrice: parseFloat(document.getElementById('prodPrice').value)
            };
            
            try {
                let res;
                if (editId) {
                    res = await authFetch(`/api/products/${editId}`, {
                        method: 'PUT',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify(data)
                    });
                } else {
                    res = await authFetch('/api/products', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify(data)
                    });
                }
                
                if (!res.ok) throw new Error('Failed');

                alert(editId ? 'Produto atualizado com sucesso!' : 'Produto cadastrado com sucesso!');
                e.target.reset();
                document.getElementById('editProductId').value = '';
                btn.innerText = 'Cadastrar Produto';
                loadProductsList();
                loadProducts();
            } catch (error) {
                alert('Erro ao salvar produto');
            } finally {
                btn.disabled = false;
                if (!document.getElementById('editProductId').value) btn.innerText = 'Cadastrar Produto';
            }
        });

        function editProduct(id, name, cost, price) {
            document.getElementById('editProductId').value = id;
            document.getElementById('prodName').value = name;
            document.getElementById('prodCost').value = cost;
            document.getElementById('prodPrice').value = price;
            
            const btn = document.querySelector('#productForm button[type="submit"]');
            btn.innerText = 'Atualizar Produto';
            
            document.getElementById('productForm').scrollIntoView({ behavior: 'smooth' });
        }

        async function deleteProduct(id) {
            if (!confirm('Tem certeza que deseja remover este produto?')) return;
            try {
                const res = await authFetch(`/api/products/${id}`, { method: 'DELETE' });
                if (res.ok) {
                    alert('Produto removido com sucesso!');
                    loadProductsList();
                    loadProducts(); // refresh select
                } else {
                    alert('Erro ao remover produto.');
                }
            } catch (err) {
                console.error(err);
                alert('Erro ao processar remo√ß√£o.');
            }
        }

        // Toggle Installments Input
        function toggleInstallments() {
            const type = document.querySelector('input[name="recurrenceType"]:checked').value;
            const group = document.getElementById('installmentsGroup');
            const dateGroup = document.getElementById('purchaseDateGroup');
            
            if (type === 'installment') {
                group.style.display = 'block';
                dateGroup.style.display = 'block';
                // Set default date if empty
                if (!document.getElementById('costPurchaseDate').value) {
                    document.getElementById('costPurchaseDate').valueAsDate = new Date();
                }
            } else {
                group.style.display = 'none';
                dateGroup.style.display = 'none';
            }
        }

        // --- Custom Product Dropdown Logic ---
        function openProductDropdown() {
            const list = document.getElementById('productDropdownList');
            if(list) list.style.display = 'block';
        }

        function filterProductDropdown(text) {
            const filter = text.toLowerCase();
            const options = document.querySelectorAll('#productDropdownList div');
            options.forEach(div => {
                const txt = div.innerText.toLowerCase();
                if (txt.includes(filter)) {
                    div.style.display = 'block';
                } else {
                    div.style.display = 'none';
                }
            });
        }

        function selectProduct(id, name) {
            document.getElementById('filterProduct').value = id;
            document.getElementById('productSearchInput').value = name;
            document.getElementById('productDropdownList').style.display = 'none';
            loadDashboard(); // Trigger update
        }

        // Close dropdown when clicking outside
        window.addEventListener('click', function(e) {
            const container = document.getElementById('productFilterContainer');
            if (container && !container.contains(e.target)) {
                const list = document.getElementById('productDropdownList');
                if(list) list.style.display = 'none';
            }
        });

        // --- Custom Product Dropdown Logic (Sales) ---
        function openProductDropdownSales() {
            const list = document.getElementById('productDropdownListSales');
            if(list) list.style.display = 'block';
        }

        function filterProductDropdownSales(text) {
            const filter = text.toLowerCase();
            const options = document.querySelectorAll('#productDropdownListSales div');
            options.forEach(div => {
                const txt = div.innerText.toLowerCase();
                if (txt.includes(filter)) {
                    div.style.display = 'block';
                } else {
                    div.style.display = 'none';
                }
            });
        }

        function selectProductFilterSales(id, name) {
            document.getElementById('filterProductSales').value = id;
            document.getElementById('productSearchInputSales').value = name;
            document.getElementById('productDropdownListSales').style.display = 'none';
            loadRecentSales(); // Trigger update
        }

        // Close dropdown when clicking outside (Sales)
        window.addEventListener('click', function(e) {
            const container = document.getElementById('productFilterContainerSales');
            if (container && !container.contains(e.target)) {
                const list = document.getElementById('productDropdownListSales');
                if(list) list.style.display = 'none';
            }
        });

        // Wait for DOM to be fully loaded before attaching listeners
        document.addEventListener('DOMContentLoaded', () => {
            console.log('DOM Loaded, attaching listeners...');

            // Cost Classification Logic
            const btnConsultar = document.getElementById('btnConsultar');
            if (btnConsultar) {
                btnConsultar.addEventListener('click', async () => {
                    const item = document.getElementById('costInput').value.trim();
                    if (!item) return;
        
                    const loading = document.getElementById('consultLoading');
                    const resultDiv = document.getElementById('consultResult');
                    const resClass = document.getElementById('resClass');
                    const resDesc = document.getElementById('resDesc');
                    const btn = document.getElementById('btnConsultar');
        
                    loading.style.display = 'block';
                    resultDiv.style.display = 'none';
                    btn.disabled = true;
        
                    try {
                        const response = await authFetch('/api/classificar-custo', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ item })
                        });
        
                        const data = await response.json();
        
                        if (data.success) {
                            const { classificacao, explicacao } = data.data;
                            
                            const isFixed = classificacao.toLowerCase().includes('fixo');
                            resultDiv.style.background = isFixed ? 'rgba(255, 68, 68, 0.1)' : 'rgba(76, 175, 80, 0.1)';
                            resultDiv.style.border = isFixed ? '1px solid #ff4444' : '1px solid #4CAF50';
                            resClass.style.color = isFixed ? '#d32f2f' : '#388e3c';
                            
                            resClass.textContent = classificacao;
                            resDesc.textContent = explicacao;
                            resultDiv.style.display = 'block';
                        } else {
                            alert('Erro: ' + data.message);
                        }
                    } catch (err) {
                        console.error(err);
                        alert('Erro ao consultar.');
                    } finally {
                        loading.style.display = 'none';
                        btn.disabled = false;
                    }
                });
            }
    
            // Register Fixed Cost (Create Only)
            const fixedCostForm = document.getElementById('fixedCostForm');
            if (fixedCostForm) {
                fixedCostForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const btn = e.target.querySelector('button');
                    const originalText = btn.innerText;
                    btn.innerText = 'Salvando...';
                    btn.disabled = true;
        
                    // No editId logic here anymore. Only create.
                    const recurrenceType = document.querySelector('input[name="recurrenceType"]:checked').value;
                    const installments = recurrenceType === 'installment' ? 
                        parseInt(document.getElementById('costInstallments').value) : 1;
                    
                    // Handle Date
                    let costDate = new Date();
                    if (recurrenceType === 'installment') {
                        const dateInput = document.getElementById('costPurchaseDate').value;
                        if (dateInput) {
                            const parts = dateInput.split('-');
                            costDate = new Date(parts[0], parts[1] - 1, parts[2], 12, 0, 0); 
                        }
                    }
        
                    // Calculate Amount (If installment, user enters TOTAL, we save PER INSTALLMENT)
                    let amount = parseFloat(document.getElementById('costAmount').value);
                    if (recurrenceType === 'installment' && installments > 0) {
                        amount = amount / installments;
                    }
        
                    const data = {
                        name: document.getElementById('costName').value,
                        amount: amount,
                        date: costDate,
                        recurrenceType,
                        installments
                    };
                    
                    try {
                        const res = await authFetch('/api/fixed-costs', {
                            method: 'POST',
                            headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify(data)
                        });
                        
                        if (!res.ok) throw new Error('Failed');
        
                        alert('Custo registrado!');
                        e.target.reset();
                        // document.getElementById('editCostId').value = ''; // No longer needed
                        btn.innerText = 'Registrar Custo';
        
                        document.querySelector('input[name="recurrenceType"][value="monthly"]').checked = true;
                        toggleInstallments();
                        loadFixedCosts();
                        loadDashboard();
                    } catch (error) {
                        alert('Erro ao salvar custo');
                    } finally {
                        btn.disabled = false;
                        btn.innerText = 'Registrar Custo';
                    }
                });
            }

            // Handle Edit Form Submit
            const editFixedCostForm = document.getElementById('editFixedCostForm');
            if (editFixedCostForm) {
                editFixedCostForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const btn = e.target.querySelector('button');
                    const originalText = btn.innerText;
                    btn.innerText = 'Salvando...';
                    btn.disabled = true;
        
                    const editId = document.getElementById('modalEditCostId').value;
                    const recurrenceType = document.querySelector('input[name="modalRecurrenceType"]:checked').value;
                    const installments = recurrenceType === 'installment' ? 
                        parseInt(document.getElementById('modalCostInstallments').value) : 1;
                    
                    // Handle Date
                    let costDate = new Date();
                    if (recurrenceType === 'installment') {
                        const dateInput = document.getElementById('modalCostPurchaseDate').value;
                        if (dateInput) {
                            const parts = dateInput.split('-');
                            costDate = new Date(parts[0], parts[1] - 1, parts[2], 12, 0, 0); 
                        }
                    }
        
                    // Calculate Amount (If installment, user enters TOTAL, we save PER INSTALLMENT)
                    let amount = parseFloat(document.getElementById('modalCostAmount').value);
                    if (recurrenceType === 'installment' && installments > 0) {
                        amount = amount / installments;
                    }
        
                    const data = {
                        name: document.getElementById('modalCostName').value,
                        amount: amount,
                        date: costDate,
                        recurrenceType,
                        installments
                    };
                    
                    try {
                        const res = await authFetch(`/api/fixed-costs/${editId}`, {
                            method: 'PUT',
                            headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify(data)
                        });
                        
                        if (!res.ok) throw new Error('Failed');
        
                        alert('Custo atualizado com sucesso!');
                        closeEditCostModal();
                        loadFixedCosts();
                        loadDashboard();
                    } catch (error) {
                        alert('Erro ao atualizar custo');
                        console.error(error);
                    } finally {
                        btn.innerText = originalText;
                        btn.disabled = false;
                    }
                });
            }
    
            // Register Sale (Create/Update)
            const saleForm = document.getElementById('saleForm');
            if (saleForm) {
                saleForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    
                    // Setup Debug UI
                    const debugEl = document.getElementById('debugStatus');
                    if (debugEl) {
                        debugEl.style.display = 'block';
                    debugEl.innerText = 'üìù Iniciando processo de venda...\\n';
                    
                    }
                    
                    function logDebug(msg) {
                        console.log(msg);
                        if (debugEl) debugEl.innerText += `> ${msg}\n`;
                    }
        
                    logDebug('Verificando bot√£o de submit...');
                    const btn = e.target.querySelector('button[type="submit"]');
                    let originalText = 'Confirmar Venda';
                    
                    if (btn) {
                        originalText = btn.innerText;
                        btn.innerText = 'Salvando...';
                        btn.disabled = true;
                    }
        
                    try {
                        logDebug('Coletando dados do formul√°rio...');
                        const editId = document.getElementById('editSaleId').value;
                        const productSelect = document.getElementById('productSelect');
                        
                        if (!productSelect.value) {
                            throw new Error('Por favor, selecione um produto.');
                        }
                        
                        const quantityInput = document.getElementById('quantity');
                        const qtyVal = parseInt(quantityInput.value);
                        if (!qtyVal || isNaN(qtyVal) || qtyVal < 1) {
                            throw new Error('Por favor, insira uma quantidade v√°lida.');
                        }
                        
                        // Verify Auth Token
                        logDebug('Verificando autentica√ß√£o...');
                        const token = localStorage.getItem('bellecake_token');
                        if (!token) throw new Error('Sess√£o expirada. Fa√ßa login novamente.');
        
                        // Calculate Fee
                        let platformFee = 0;
                        if (document.getElementById('hasFee').checked) {
                            const feeTypeEl = document.querySelector('input[name="feeType"]:checked');
                            if (!feeTypeEl) throw new Error('Selecione o tipo de taxa (Fixo ou %).');
                            
                            const feeType = feeTypeEl.value;
                            const feeInputVal = parseFloat(document.getElementById('platformFee').value || 0);
                            
                            if (feeType === 'percent') {
                                const option = productSelect.options[productSelect.selectedIndex];
                                const priceStr = option.text.split(' - R$')[1];
                                const price = parseFloat(priceStr || 0);
                                const totalBruto = price * qtyVal;
                                
                                platformFee = totalBruto * (feeInputVal / 100);
                                logDebug(`Taxa calculada (%): ${platformFee}`);
                            } else {
                                platformFee = feeInputVal;
                                logDebug(`Taxa fixa: ${platformFee}`);
                            }
                        }
        
                        const data = {
                            productId: productSelect.value,
                            quantity: qtyVal,
                            date: document.getElementById('saleDate').value,
                            paymentMethod: document.getElementById('paymentMethod').value,
                            platformFee: platformFee,
                            deliveryFee: document.getElementById('hasDelivery').checked ? parseFloat(document.getElementById('deliveryFee').value || 0) : 0,
                            notes: document.getElementById('saleNotes').value
                        };
                        
                        logDebug(`Dados preparados: ${JSON.stringify(data)}`);
        
                        const url = editId ? `/api/sales/${editId}` : '/api/sales';
                        const method = editId ? 'PUT' : 'POST';
        
                        logDebug(`Enviando requisi√ß√£o ${method} para ${url}...`);
        
                        // Use authFetch for consistency and error handling
                        const res = await authFetch(url, {
                            method: method,
                            body: JSON.stringify(data)
                        });
                        
                        logDebug(`Status da resposta: ${res.status}`);
                        
                        if (!res.ok) {
                            const err = await res.json().catch(() => ({ error: 'Erro desconhecido no servidor' }));
                            logDebug(`Erro do servidor: ${JSON.stringify(err)}`);
                            throw new Error(err.error || 'Erro ao salvar venda no servidor.');
                        }
        
                        const result = await res.json();
                        logDebug('‚úÖ Sucesso! Venda registrada.');
        
                        alert(editId ? 'Venda atualizada com sucesso!' : 'Venda registrada com sucesso!');
                        e.target.reset();
                        if(saleDatePicker) saleDatePicker.setDate(new Date());
                        
                        // Reset Steps
                        goToStep1();
                        
                        // Reset Checkboxes and Hidden Inputs
                        document.getElementById('hasFee').checked = false;
                        document.getElementById('hasDelivery').checked = false;
                        toggleFeeInput();
                        toggleDeliveryInput();
                        
                        // Switch to Vendas view automatically
                        switchView('vendas');
                        loadRecentSales();
                        loadUserInfo(); // Refresh progress bar
                        
                        // Wait a bit before closing so user sees the log
                        setTimeout(() => {
                            closeSaleModal();
                            debugEl.style.display = 'none';
                            debugEl.innerText = '';
                        }, 1000);
        
                    } catch (error) {
                        logDebug(`‚ùå ERRO: ${error.message}`);
                        console.error('Catch Error:', error);
                        alert('Erro ao registrar venda: ' + (error.message || 'Erro desconhecido'));
                    } finally {
                        if (btn) {
                            btn.innerText = originalText;
                            btn.disabled = false;
                        }
                    }
                });
            }
        });

        // --- Step Navigation & Logic ---
        function goToStep1() {
            document.getElementById('step1').style.display = 'block';
            document.getElementById('step2').style.display = 'none';
            document.getElementById('stepSummary').style.display = 'none';
            
            document.getElementById('step1-indicator').classList.add('active');
            document.getElementById('step2-indicator').classList.remove('active');
            
            // Show Audio Player
            const voiceContainer = document.getElementById('voiceRecordContainer');
            if(voiceContainer) voiceContainer.style.display = 'block';
        }

        function goToStep2() {
            const product = document.getElementById('productSelect').value;
            const qty = document.getElementById('quantity').value;
            const date = document.getElementById('saleDate').value;

            if (!product || !qty || !date) {
                alert('Por favor, preencha todos os campos obrigat√≥rios.');
                return;
            }

            document.getElementById('step1').style.display = 'none';
            document.getElementById('step2').style.display = 'block';
            document.getElementById('stepSummary').style.display = 'none';

            document.getElementById('step1-indicator').classList.remove('active');
            document.getElementById('step2-indicator').classList.add('active');

            // Hide Audio Player
            const voiceContainer = document.getElementById('voiceRecordContainer');
            if(voiceContainer) voiceContainer.style.display = 'none';
        }

        async function goToSummary() {
            // Get Values
            const productId = document.getElementById('productSelect').value;
            const qty = parseInt(document.getElementById('quantity').value);
            const deliveryFee = document.getElementById('hasDelivery').checked ? parseFloat(document.getElementById('deliveryFee').value || 0) : 0;
            
            // Fetch Product Details for accurate calculation
            let productName = 'Produto';
            let totalBruto = 0;
            let platformFee = 0;
            let variableCostTotal = 0; // Initialize variableCostTotal
            
            try {
                // We can find the product in the select options to avoid an API call if possible, 
                // but we need the price. The select option text has the price.
                const select = document.getElementById('productSelect');
                if (select.selectedIndex === -1) throw new Error('Selecione um produto');
                
                const option = select.options[select.selectedIndex];
                const optionText = option.text; // "Name - R$ 0.00"
                
                productName = optionText.split(' - R$')[0];
                const priceStr = optionText.split(' - R$')[1];
                const price = parseFloat(priceStr);
                
                totalBruto = price * qty;

                // Calculate Variable Cost
                if (typeof window.productsData !== 'undefined' && window.productsData) {
                    const product = window.productsData.find(p => p._id === productId);
                    if (product) {
                        variableCostTotal = (product.variableCost || 0) * qty;
                    }
                } else {
                     console.warn('productsData not loaded globally');
                }
                
                // Calculate Fee based on Type
                if (document.getElementById('hasFee').checked) {
                    const feeType = document.querySelector('input[name="feeType"]:checked').value;
                    const feeInputVal = parseFloat(document.getElementById('platformFee').value || 0);
                    
                    if (feeType === 'percent') {
                        platformFee = totalBruto * (feeInputVal / 100);
                    } else {
                        platformFee = feeInputVal;
                    }
                }
                
            } catch (e) {
                console.error('Error calculating summary', e);
            }

            const liquido = totalBruto - platformFee - deliveryFee - variableCostTotal;

            // Populate Summary
            document.getElementById('summaryProduct').innerText = productName;
            document.getElementById('summaryQuantity').innerText = qty;
            document.getElementById('summaryTotal').innerText = totalBruto.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
            document.getElementById('summaryFees').innerText = '- ' + platformFee.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
            document.getElementById('summaryVariableCost').innerText = '- ' + variableCostTotal.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
            document.getElementById('summaryDelivery').innerText = '- ' + deliveryFee.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
            document.getElementById('summaryNet').innerText = liquido.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });

            // Show Summary
            document.getElementById('step1').style.display = 'none';
            document.getElementById('step2').style.display = 'none';
            document.getElementById('stepSummary').style.display = 'block';
        }

        function toggleFeeInput() {
            const checked = document.getElementById('hasFee').checked;
            document.getElementById('feeInputContainer').style.display = checked ? 'block' : 'none';
            if (!checked) {
                document.getElementById('platformFee').value = 0;
            } else {
                updateFeePlaceholder();
            }
        }

        function updateFeePlaceholder() {
            const feeType = document.querySelector('input[name="feeType"]:checked').value;
            const feeInput = document.getElementById('platformFee');
            if (feeType === 'percent') {
                feeInput.placeholder = "Ex: 10 (para 10%)";
                feeInput.max = "100";
            } else {
                feeInput.placeholder = "0.00";
                feeInput.removeAttribute('max');
            }
        }

        function toggleDeliveryInput() {
            const checked = document.getElementById('hasDelivery').checked;
            document.getElementById('deliveryInputContainer').style.display = checked ? 'block' : 'none';
            if (!checked) document.getElementById('deliveryFee').value = 0;
        }

        function checkPaymentMethod() {
            const method = document.getElementById('paymentMethod').value;
            if (method === 'platform') {
                document.getElementById('hasFee').checked = true;
                toggleFeeInput();
            }
        }


        // Chart.js Setup
        // salesChartInstance & ticketChartInstance defined at top of script

        function updateCharts(chartData) {
            updateSalesChart(chartData);
            updateTicketChart(chartData);
        }

        function updateSalesChart(data) {
            const ctx = document.getElementById('salesChart').getContext('2d');
            if (salesChartInstance) salesChartInstance.destroy();

            salesChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.labels,
                    datasets: [{
                        label: 'Vendas (R$)',
                        data: data.revenue,
                        borderColor: '#CD7A3E',
                        backgroundColor: 'rgba(205, 122, 62, 0.1)',
                        borderWidth: 3,
                        tension: 0.3,
                        fill: true,
                        pointBackgroundColor: '#FFF',
                        pointBorderColor: '#CD7A3E',
                        pointBorderWidth: 2,
                        pointRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: { color: 'rgba(0,0,0,0.05)' },
                            ticks: { 
                                stepSize: 100,
                                callback: function(value) { return 'R$ ' + value; }
                            }
                        },
                        x: { grid: { display: false } }
                    }
                }
            });
        }

        function updateTicketChart(data) {
            const ctx = document.getElementById('ticketChart').getContext('2d');
            if (ticketChartInstance) ticketChartInstance.destroy();

            ticketChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.labels,
                    datasets: [{
                        label: 'Ticket M√©dio (R$)',
                        data: data.ticket,
                        borderColor: '#4CAF50',
                        backgroundColor: 'rgba(76, 175, 80, 0.1)',
                        borderWidth: 3,
                        tension: 0.3,
                        fill: true,
                        pointBackgroundColor: '#FFF',
                        pointBorderColor: '#4CAF50',
                        pointBorderWidth: 2,
                        pointRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: { color: 'rgba(0,0,0,0.05)' },
                            ticks: { 
                                callback: function(value) { return 'R$ ' + value; }
                            }
                        },
                        x: { grid: { display: false } }
                    }
                }
            });
        }

        // Init
        loadDashboard();
        loadProductsList();
        loadRecentSales();
        loadMonthlyMeta(); // Fetch specific meta data

        async function loadMonthlyMeta() {
            try {
                // Determine This Month Range (Local Time aligned)
                const now = new Date();
                const start = new Date(now.getFullYear(), now.getMonth(), 1);
                start.setHours(0,0,0,0);
                const end = new Date(now.getFullYear(), now.getMonth() + 1, 0);
                end.setHours(23,59,59,999);
                
                const query = `?start=${start.toISOString()}&end=${end.toISOString()}`;
                
                const res = await authFetch(`/api/dashboard/stats${query}`);
                if (!res.ok) throw new Error('Failed to load meta');
                
                const data = await res.json();
                const stats = data.summary;
                
                // Update Break Even Card
                // Goal = Total Fixed Costs (Meta de Equil√≠brio)
                const goal = stats.totalFixedCost;
                const current = stats.totalRevenue; // Monthly revenue
                
                const card = document.getElementById('breakEvenGoalCard');
                if (card) {
                    card.style.display = 'block';
                    
                    // Prevent division by zero
                    let percent = 0;
                    if (goal > 0) {
                        percent = Math.min((current / goal) * 100, 100);
                    } else if (current > 0) {
                        percent = 100;
                    }
                    
                    const elGoal = document.getElementById('beGoalValue');
                    const elCurrent = document.getElementById('beCurrentValue');
                    const elPercent = document.getElementById('bePercentage');
                    const elBar = document.getElementById('beProgressBar');
                    
                    if(elGoal) elGoal.textContent = goal.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
                    if(elCurrent) elCurrent.textContent = current.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
                    if(elPercent) elPercent.textContent = percent.toFixed(1) + '%';
                    if(elBar) elBar.style.width = percent + '%';
                }
                
            } catch (error) {
                console.error('Error loading monthly meta:', error);
            }
        }

        // Costs Chart Modal Logic
        // costsChartInstance defined at top of script

        function openCostsChartModal() {
            document.getElementById('costsChartModal').style.display = 'flex';
            renderCostsChart();
        }

        function closeCostsChartModal() {
            document.getElementById('costsChartModal').style.display = 'none';
        }

        async function renderCostsChart() {
            const ctx = document.getElementById('costsPieChart').getContext('2d');
            
            // Destroy existing if any
            if (costsChartInstance) {
                costsChartInstance.destroy();
            }

            // Fetch current costs breakdown
            try {
                // We use existing global data or fetch fresh
                const res = await authFetch('/api/fixed-costs?period=this_month');
                const costs = await res.json();
                
                if (!costs || costs.length === 0) {
                    // Draw empty chart or just return?
                    // Better to clear rect
                    ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
                    ctx.font = "16px Inter";
                    ctx.fillStyle = "#888";
                    ctx.textAlign = "center";
                    ctx.fillText("Nenhum custo cadastrado.", ctx.canvas.width/2, ctx.canvas.height/2);
                    return;
                }

                // Group by name
                const dataRaw = costs.map(c => c);
                // Sort by amount descending (maior percentual primeiro)
                dataRaw.sort((a, b) => b.amount - a.amount);
                
                const data = dataRaw.map(c => c.amount);
                const totalCost = data.reduce((a, b) => a + b, 0);
                
                const labels = dataRaw.map(c => {
                    const percentage = totalCost > 0 ? ((c.amount / totalCost) * 100).toFixed(1) + '%' : '0%';
                    return `${c.name} (${percentage})`;
                });
                
                // Vivid Colors - High Contrast & Distinct
                const baseColors = [
                    '#FF3333', // Vivid Red
                    '#33FF33', // Vivid Green
                    '#3357FF', // Vivid Blue
                    '#FF33A8', // Hot Pink
                    '#FF8C00', // Dark Orange
                    '#9933FF', // Purple
                    '#00CED1', // Dark Turquoise
                    '#FFD700', // Gold
                    '#DC143C', // Crimson
                    '#00FF7F'  // Spring Green
                ];
                // Cycle through colors if needed
                const colors = costs.map((_, i) => baseColors[i % baseColors.length]);

                // Responsive Legend Position
                const isMobile = window.innerWidth < 600;
                const legendPosition = isMobile ? 'bottom' : 'right';

                costsChartInstance = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: labels,
                        datasets: [{
                            data: data,
                            backgroundColor: colors,
                            borderWidth: 2,
                            borderColor: '#ffffff',
                            hoverOffset: 10
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        layout: {
                            padding: 20
                        },
                        plugins: {
                            legend: {
                                position: legendPosition,
                                labels: {
                                    boxWidth: 20,
                                    padding: 15,
                                    font: {
                                        size: 14,
                                        family: "'Inter', sans-serif"
                                    },
                                    color: '#5D4037'
                                }
                            },
                            tooltip: {
                                backgroundColor: 'rgba(255, 255, 255, 0.95)',
                                titleColor: '#5D4037',
                                bodyColor: '#5D4037',
                                bodyFont: { size: 14 },
                                titleFont: { size: 16, weight: 'bold' },
                                borderColor: '#E0E0E0',
                                borderWidth: 1,
                                padding: 12,
                                displayColors: true,
                                callbacks: {
                                    label: function(context) {
                                        let label = context.label || '';
                                        if (label) {
                                            label += ': ';
                                        }
                                        if (context.parsed !== null) {
                                            label += context.parsed.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
                                            // Add percentage
                                            const total = context.chart._metasets[context.datasetIndex].total;
                                            const percentage = ((context.parsed / total) * 100).toFixed(1) + '%';
                                            label += ` (${percentage})`;
                                        }
                                        return label;
                                    }
                                }
                            },
                            title: {
                                display: false
                            }
                        },
                        cutout: '60%',
                        animation: {
                            animateScale: true,
                            animateRotate: true
                        }
                    }
                });
            } catch (err) {
                console.error('Error rendering costs chart:', err);
            }
        }
        // --- UI Toggles ---
        function toggleUserMenu() {
            const menu = document.getElementById('userMenuDropdown');
            if (menu) {
                menu.style.display = menu.style.display === 'flex' ? 'none' : 'flex';
            }
        }

        function toggleMetaCard(show) {
            const card = document.getElementById('breakEvenGoalCard');
            if (card) {
                if (show) {
                    card.style.display = 'block';
                    localStorage.removeItem('metaCardHidden');
                    // Hide menu if open
                    const menu = document.getElementById('userMenuDropdown');
                    if (menu) menu.style.display = 'none';
                } else {
                    card.style.display = 'none';
                    localStorage.setItem('metaCardHidden', 'true');
                }
            }
        }

        // Close user menu when clicking outside
        document.addEventListener('click', (e) => {
            const menu = document.getElementById('userMenuDropdown');
            const trigger = document.querySelector('[onclick="toggleUserMenu()"]');
            if (menu && menu.style.display === 'flex' && trigger && !menu.contains(e.target) && !trigger.contains(e.target)) {
                menu.style.display = 'none';
            }
        });

        // --- Edit/Delete Sale Logic ---
        async function editSale(id) {
            const sale = window.recentSalesData.find(s => s._id === id);
            if (!sale) return;

            await openSaleModal();
            
            // Set fields
            document.getElementById('editSaleId').value = sale._id;
            
            const productSelect = document.getElementById('productSelect');
            if(sale.product) {
                productSelect.value = sale.product._id || sale.product;
            }
            
            document.getElementById('quantity').value = sale.quantity;
            document.getElementById('paymentMethod').value = sale.paymentMethod;
            
            // Date
            if (saleDatePicker) {
                saleDatePicker.setDate(new Date(sale.date));
            } else {
                document.getElementById('saleDate').value = formatDateLocal(new Date(sale.date));
            }
            
            // Notes
            document.getElementById('saleNotes').value = sale.notes || '';
            
            // Fees
            if (sale.platformFee && sale.platformFee > 0) {
                document.getElementById('hasFee').checked = true;
                toggleFeeInput();
                // Assume fixed for simplicity as we store absolute value
                document.querySelector('input[name="feeType"][value="fixed"]').checked = true;
                updateFeePlaceholder();
                document.getElementById('platformFee').value = sale.platformFee;
            } else {
                 document.getElementById('hasFee').checked = false;
                 toggleFeeInput();
            }
            
            if (sale.deliveryFee && sale.deliveryFee > 0) {
                document.getElementById('hasDelivery').checked = true;
                toggleDeliveryInput();
                document.getElementById('deliveryFee').value = sale.deliveryFee;
            } else {
                document.getElementById('hasDelivery').checked = false;
                toggleDeliveryInput();
            }

            // UI Text
            document.querySelector('#newSaleModal h3').innerText = 'Editar Venda';
            const submitBtn = document.querySelector('#saleForm button[type="submit"]');
            if(submitBtn) submitBtn.innerText = 'Salvar Altera√ß√µes';
            
            // Step 1
            goToStep1();
        }

        async function deleteSale(id) {
            if(!confirm('Tem certeza que deseja excluir esta venda?')) return;
            
            try {
                const res = await authFetch(`/api/sales/${id}`, {
                    method: 'DELETE'
                });
                
                if (res.ok) {
                    alert('Venda exclu√≠da com sucesso!');
                    loadRecentSales();
                    loadDashboard(); // Refresh stats
                } else {
                    const data = await res.json();
                    alert('Erro ao excluir: ' + (data.error || 'Erro desconhecido'));
                }
            } catch (err) {
                console.error(err);
                alert('Erro ao excluir venda.');
            }
        }
    </script>

    <!-- Costs Chart Modal -->
    <div id="costsChartModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); backdrop-filter: blur(4px); z-index: 1000; justify-content: center; align-items: center; padding: 1rem;">
        <style>
            .costs-modal-content {
                background: white; 
                width: 100%; 
                max-width: 800px; 
                padding: 2.5rem; 
                border-radius: 24px; 
                box-shadow: 0 10px 40px rgba(0,0,0,0.2); 
                position: relative; 
                display: flex; 
                flex-direction: column; 
                align-items: center;
            }
            .chart-container-modal {
                position: relative; 
                height: 500px; 
                width: 100%;
            }
            @media (max-width: 768px) {
                .costs-modal-content {
                    padding: 1.5rem;
                    max-height: 85vh;
                    overflow-y: auto;
                }
                .chart-container-modal {
                    height: 300px;
                }
                #costsChartModal h2 {
                    font-size: 1.4rem !important;
                    margin-bottom: 1rem !important;
                }
            }
        </style>
        <div class="costs-modal-content">
            <button onclick="closeCostsChartModal()" style="position: absolute; top: 1.5rem; right: 1.5rem; background: #f5f5f5; border: none; cursor: pointer; padding: 0.5rem; border-radius: 50%; display: flex; align-items: center; justify-content: center; transition: background 0.2s; z-index: 10;">
                <i data-lucide="x" style="width: 24px; height: 24px; color: #666;"></i>
            </button>
            
            <h2 style="margin-top: 0; margin-bottom: 2rem; text-align: center; color: var(--text-brown); font-size: 1.8rem; font-weight: 700;">
                Distribui√ß√£o de Custos Fixos
            </h2>
            
            <div class="chart-container-modal">
                <canvas id="costsPieChart"></canvas>
            </div>
            
            <p style="margin-top: 1.5rem; color: #888; font-size: 0.9rem; text-align: center;">
                * Valores baseados nos custos cadastrados para este m√™s.
            </p>
        </div>
    </div>

    <!-- Edit Fixed Cost Modal -->
    <div id="editCostModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); backdrop-filter: blur(4px); z-index: 1000; justify-content: center; align-items: center; padding: 1rem;">
        <div style="background: white; width: 100%; max-width: 500px; padding: 2rem; border-radius: 24px; box-shadow: 0 10px 40px rgba(0,0,0,0.2); position: relative; display: flex; flex-direction: column;">
            <button onclick="closeEditCostModal()" style="position: absolute; top: 1.5rem; right: 1.5rem; background: #f5f5f5; border: none; cursor: pointer; padding: 0.5rem; border-radius: 50%; display: flex; align-items: center; justify-content: center; transition: background 0.2s;">
                <i data-lucide="x" style="width: 24px; height: 24px; color: #666;"></i>
            </button>
            
            <h2 style="margin-top: 0; margin-bottom: 1.5rem; color: var(--text-brown); font-size: 1.5rem; font-weight: 700;">
                Editar Custo Fixo
            </h2>
            
            <form id="editFixedCostForm">
                <input type="hidden" id="modalEditCostId">
                <div class="form-group">
                    <label>Nome do Custo</label>
                    <input type="text" id="modalCostName" required>
                </div>
                <div class="form-group">
                    <label>Valor (R$)</label>
                    <input type="number" id="modalCostAmount" step="0.01" required>
                </div>
                
                <div class="form-group">
                    <label style="display: block; margin-bottom: 0.5rem;">Recorr√™ncia</label>
                    <div style="display: flex; gap: 1rem;">
                        <label style="display: flex; align-items: center; cursor: pointer;">
                            <input type="radio" name="modalRecurrenceType" value="monthly" checked onchange="toggleModalInstallments()" style="margin-right: 8px;">
                            Mensal
                        </label>
                        <label style="display: flex; align-items: center; cursor: pointer;">
                            <input type="radio" name="modalRecurrenceType" value="installment" onchange="toggleModalInstallments()" style="margin-right: 8px;">
                            Parcelado
                        </label>
                    </div>
                </div>

                <div id="modalInstallmentGroup" style="display: none;">
                    <div class="form-group">
                        <label>N√∫mero de Parcelas</label>
                        <input type="number" id="modalCostInstallments" min="1" placeholder="Ex: 12">
                    </div>
                    <div class="form-group">
                        <label>Data da Compra</label>
                        <input type="date" id="modalCostPurchaseDate">
                        <small style="color: #888; display: block; margin-top: 0.3rem;">Define quando come√ßa a contar as parcelas.</small>
                    </div>
                </div>

                <button type="submit" class="btn-primary" style="width: 100%; margin-top: 1rem;">Salvar Altera√ß√µes</button>
            </form>
        </div>
    </div>
</body>
</html>
                </div>

                <button type="submit" class="btn-primary" style="width: 100%; margin-top: 1rem;">Salvar Altera√ß√µes</button>
            </form>
        </div>
    </div>
</body>
</html>
